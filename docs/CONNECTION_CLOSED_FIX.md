# ERR_CONNECTION_CLOSED 错误修复指南

## 问题描述

处理视频时出现错误：
```
POST https://beatsync-backend-asha.onrender.com/api/process 
net::ERR_CONNECTION_CLOSED
```

## 问题原因

### 1. Render服务休眠（最常见）

**问题**：
- Render免费层在15分钟无活动后会休眠
- 首次访问需要50秒左右唤醒
- 如果处理时间过长，服务可能再次休眠

**症状**：
- 请求发送后连接立即关闭
- 错误：`ERR_CONNECTION_CLOSED`

### 2. 请求超时

**问题**：
- Render免费层HTTP请求有超时限制（通常30秒）
- 视频处理需要几分钟，超过超时限制
- 连接被强制关闭

**症状**：
- 请求发送后一段时间连接关闭
- 错误：`ERR_CONNECTION_CLOSED` 或 `timeout`

### 3. 后端服务崩溃

**问题**：
- 处理过程中内存不足
- 或其他错误导致服务重启

**症状**：
- 处理过程中连接突然关闭
- Render日志显示错误或重启

### 4. 网络连接问题

**问题**：
- 网络不稳定导致连接中断

**症状**：
- 随机出现连接错误

## 解决方案

### 方案1：等待服务唤醒（临时）

如果服务已休眠：

1. **等待50秒左右**
   - Render服务需要时间唤醒
   - 可以访问健康检查接口：https://beatsync-backend-asha.onrender.com/api/health
   - 等待返回正常后再重试

2. **使用较小的测试视频**
   - 使用几MB的小视频测试
   - 确认流程正常后再处理大视频

### 方案2：检查Render服务状态

1. **访问Render Dashboard**
   - https://dashboard.render.com
   - 进入后端服务：`beatsync-backend-asha`

2. **检查服务状态**
   - 状态应该是 "Live"（绿色）
   - 如果是 "Sleeping"，需要等待唤醒

3. **查看日志**
   - 点击 "Logs" 标签
   - 查看是否有错误信息
   - 查看服务是否正常启动

### 方案3：使用免费监控服务（推荐）

使用免费监控服务定期ping后端，防止服务休眠：

1. **UptimeRobot**（推荐）
   - 访问：https://uptimerobot.com
   - 注册免费账号
   - 添加监控：
     - URL: `https://beatsync-backend-asha.onrender.com/api/health`
     - 监控间隔：5分钟
   - 这样服务就不会休眠

2. **其他监控服务**
   - Pingdom
   - StatusCake
   - 等

### 方案4：改为异步处理（长期方案）

**优点**：
- 不受HTTP超时限制
- 更好的用户体验
- 可以处理长时间任务

**实现方式**：
- 使用Celery + Redis（需要付费服务）
- 或使用Render的Background Workers
- 前端轮询或WebSocket获取处理状态

### 方案5：升级Render计划

**优点**：
- 支持更长的超时时间
- 更多资源（CPU、内存）
- 服务不会休眠

**缺点**：
- 需要付费（$7/月起）

## 已实现的改进

### 1. 添加超时控制

前端现在有5分钟超时控制，超时后会显示友好提示。

### 2. 改进错误提示

连接中断时会显示更友好的错误信息，说明可能的原因和解决方案。

## 诊断步骤

### 步骤1：检查服务状态

1. **访问健康检查接口**
   ```
   https://beatsync-backend-asha.onrender.com/api/health
   ```
   - 如果返回正常，说明服务运行中
   - 如果超时或404，说明服务已休眠

2. **等待服务唤醒**
   - 如果服务已休眠，等待50秒左右
   - 再次访问健康检查接口
   - 确认服务已唤醒

### 步骤2：检查Render日志

1. **访问Render Dashboard**
2. **查看日志**
   - 点击 "Logs" 标签
   - 查看最近的日志
   - 查找错误信息

### 步骤3：使用较小的测试视频

1. **使用小视频测试**
   - 几MB的小视频
   - 几秒钟的时长
   - 确认流程正常

2. **如果小视频可以**
   - 说明是超时或资源问题
   - 考虑升级计划或改为异步处理

## 临时解决方案

如果需要立即使用：

1. **使用本地处理**
   - 在本地运行后端服务
   - 前端连接到本地后端
   - 不受超时限制

2. **分批处理**
   - 将大视频分成小段
   - 分别处理后再合并

## 长期解决方案

### 推荐：使用UptimeRobot防止休眠

1. **注册UptimeRobot**
   - https://uptimerobot.com
   - 免费账号支持50个监控

2. **添加监控**
   - URL: `https://beatsync-backend-asha.onrender.com/api/health`
   - 监控间隔：5分钟
   - 这样服务就不会休眠

3. **或升级Render计划**
   - 付费计划服务不会休眠
   - 支持更长的超时时间

## 常见问题

### Q1: 为什么服务会休眠？

A: Render免费层为了节省资源，在15分钟无活动后会让服务休眠。这是免费服务的限制。

### Q2: 如何防止服务休眠？

A: 使用免费监控服务（如UptimeRobot）定期ping服务，或升级到付费计划。

### Q3: 处理时间太长怎么办？

A: 考虑：
1. 使用较小的测试视频
2. 改为异步处理
3. 升级Render计划

### Q4: 可以增加超时时间吗？

A: Render免费层的超时限制是固定的，无法修改。需要升级到付费计划或改为异步处理。

## 需要帮助？

如果问题仍然存在，请提供：

1. **Render服务状态**（Dashboard中的状态）
2. **Render日志**（最近的错误信息）
3. **测试视频大小**（文件大小、时长）
4. **健康检查结果**（访问 `/api/health` 的结果）

