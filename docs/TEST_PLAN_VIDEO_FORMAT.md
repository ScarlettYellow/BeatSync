# 视频格式兼容性测试方案

## 一、测试样本

### 1.1 原始样本（MP4格式）
- `echo/` - dance.MP4, bgm.MP4
- `fallingout_short/` - dance.mp4, bgm.MP4
- `famous_short/` - dance.mp4, bgm.mp4

### 1.2 测试格式选择（根据实际使用场景调整）

#### 最高优先级（必须测试 - 实际用户场景）
1. **MOV (H.264)** - iPhone拍摄视频，最常见用户输入
2. **MP4 (H.265/HEVC)** - 安卓手机拍摄（新机型常用H.265编码）
3. **MP4 (H.264)** - 安卓手机拍摄（旧机型）和社交媒体下载

#### 高优先级（必须测试 - 格式兼容性）
4. **MOV (H.265)** - iPhone新机型可能使用（如果支持）
5. **压缩MP4** - 模拟社交媒体下载视频（低码率、压缩）

#### 中优先级（建议测试 - 边界情况）
6. **AVI** - 传统格式，兼容性测试
7. **MKV** - 开源容器，部分用户可能使用

#### 低优先级（可选）
8. **WebM** - 网页常用格式
9. **M4V** - Apple格式（与MP4类似）

---

## 二、测试方案设计

### 2.1 测试场景矩阵（根据实际使用场景设计）

#### 核心场景（实际用户场景 - 必须测试）
| 样本 | dance格式 | bgm格式 | 测试目的 | 优先级 |
|------|-----------|---------|----------|--------|
| echo | MP4 (H.264原) | MP4 (H.264原) | 基准测试 | ⭐⭐⭐ |
| echo | MOV (H.264) | MP4 (H.264) | iPhone dance + 安卓bgm | ⭐⭐⭐ |
| echo | MP4 (H.264) | MOV (H.264) | 安卓dance + iPhone bgm | ⭐⭐⭐ |
| echo | MOV (H.264) | MOV (H.264) | iPhone + iPhone | ⭐⭐⭐ |
| echo | MP4 (H.265) | MP4 (H.264) | 新安卓dance + 旧安卓bgm | ⭐⭐⭐ |
| echo | MP4 (H.264) | MP4 (H.265) | 旧安卓dance + 新安卓bgm | ⭐⭐⭐ |
| fallingout_short | MP4 (H.264原) | MP4 (H.264原) | 基准测试 | ⭐⭐⭐ |
| fallingout_short | MOV (H.264) | MOV (H.264) | iPhone + iPhone | ⭐⭐⭐ |
| fallingout_short | MP4 (H.265) | MP4 (H.265) | 新安卓 + 新安卓 | ⭐⭐⭐ |
| famous_short | MP4 (H.264原) | MP4 (H.264原) | 基准测试 | ⭐⭐⭐ |
| famous_short | MOV (H.264) | MP4 (H.265) | iPhone + 新安卓 | ⭐⭐⭐ |
| famous_short | MP4 (压缩) | MP4 (压缩) | 社交媒体下载视频 | ⭐⭐ |

#### 兼容性场景（格式兼容性测试）
| 样本 | dance格式 | bgm格式 | 测试目的 | 优先级 |
|------|-----------|---------|----------|--------|
| echo | AVI | MP4 | AVI格式兼容性 | ⭐⭐ |
| echo | MKV | MP4 | MKV格式兼容性 | ⭐ |

**总计：14个测试场景（核心12个 + 兼容性2个）**

### 2.2 转换命令

#### 零损失转换（stream copy）
```bash
# MOV格式（H.264，iPhone常用）
ffmpeg -y -i input.mp4 -c copy -movflags +faststart output.mov

# MP4格式（H.265/HEVC，新安卓手机）
ffmpeg -y -i input.mp4 -c:v libx265 -preset fast -crf 23 -c:a copy output_h265.mp4

# AVI格式
ffmpeg -y -i input.mp4 -c copy output.avi

# MKV格式
ffmpeg -y -i input.mp4 -c copy output.mkv
```

#### 压缩转换（模拟社交媒体下载视频）
```bash
# 压缩MP4（低码率，模拟抖音/小红书下载）
ffmpeg -y -i input.mp4 -c:v libx264 -preset fast -crf 28 -b:v 1M -c:a aac -b:a 128k output_compressed.mp4
```

**注意**：
- MOV/AVI/MKV：使用stream copy，零损失
- H.265 MP4：需要重新编码（但保持高质量）
- 压缩MP4：模拟社交媒体视频（低码率），用于测试鲁棒性

### 2.3 验证方法

#### 准确性验证（核心）
1. **对齐点对比**：转换格式后的对齐点应与MP4原版完全一致
   - dance对齐点（秒）
   - bgm对齐点（秒）
   - 置信度/得分

2. **输出视频时长对比**：最终输出视频时长应一致
   - 输出视频总时长
   - 裁剪起点和终点

3. **音频质量对比**：使用ffprobe检查音频参数
   - 采样率
   - 声道数
   - 编码格式

#### 鲁棒性验证
1. **处理成功率**：所有格式组合都能成功处理
2. **错误处理**：转换失败时的兜底机制
3. **临时文件清理**：转换后的临时文件是否正确清理

### 2.4 测试流程

```
1. 准备阶段
   - 将3组样本转换为不同格式：
     * MOV (H.264) - iPhone格式
     * MP4 (H.265) - 新安卓格式
     * MP4 (压缩) - 社交媒体格式
     * AVI, MKV - 兼容性测试
   - 创建测试目录结构

2. 基准测试（MP4 H.264原版）
   - 对每组样本用MP4 H.264原版处理
   - 记录对齐点、时长、输出路径

3. 格式转换测试（分优先级）
   - 核心场景测试（12个）：
     * iPhone格式（MOV）
     * 新安卓格式（H.265）
     * 社交媒体格式（压缩）
   - 兼容性场景测试（2个）：
     * AVI, MKV格式
   - 记录对齐点、时长、输出路径
   - 对比基准测试结果

4. 结果验证
   - 对齐点差异 < 0.01秒（允许微小浮点误差）
   - 输出时长差异 < 0.1秒
   - 处理成功率 = 100%（核心场景必须100%）

5. 生成测试报告
   - 测试场景列表（按优先级分类）
   - 对齐点对比表
   - 时长对比表
   - 成功率统计（核心场景 vs 兼容性场景）
```

---

## 三、测试脚本设计

### 3.1 格式转换脚本
```python
# convert_test_formats.py
# 将MP4样本转换为不同格式
```

### 3.2 批量测试脚本
```python
# test_format_compatibility.py
# 批量测试不同格式组合
# 生成对比报告
```

### 3.3 验证脚本
```python
# verify_format_results.py
# 对比基准测试和格式转换测试的结果
# 生成验证报告
```

---

## 四、预期结果

### 4.1 成功标准
- ✅ **对齐点一致性**：所有格式的对齐点与MP4原版一致（差异 < 0.01秒）
- ✅ **输出时长一致性**：所有格式的输出时长与MP4原版一致（差异 < 0.1秒）
- ✅ **处理成功率**：100%（所有格式组合都能成功处理）
- ✅ **临时文件清理**：转换后的临时文件全部清理

### 4.2 失败处理
- ⚠️ **转换失败**：记录失败原因，使用原文件继续处理（兜底）
- ⚠️ **处理失败**：记录失败原因，分析是否为格式问题
- ⚠️ **结果不一致**：详细记录差异，分析原因

---

## 五、测试执行计划

### 阶段1：格式转换（5分钟）
- 将3组样本转换为MOV、AVI、MKV格式
- 验证转换文件完整性

### 阶段2：基准测试（10分钟）
- 用MP4原版处理3组样本
- 记录基准结果

### 阶段3：格式测试（30分钟）
- 批量处理所有格式组合
- 记录处理结果

### 阶段4：结果验证（10分钟）
- 对比基准测试和格式测试结果
- 生成测试报告

**总预计时间：约1小时**

---

## 六、测试报告格式

### 6.1 测试报告内容
```
# 视频格式兼容性测试报告

## 测试环境
- 测试时间：YYYY-MM-DD HH:MM
- 测试样本：3组（echo, fallingout_short, famous_short）
- 测试格式：MOV (H.264), MP4 (H.265), MP4 (压缩), AVI, MKV
- 测试场景：14个（核心12个 + 兼容性2个）

## 测试结果汇总
- 总测试场景：14
- 核心场景：12（必须100%成功）
- 兼容性场景：2
- 成功场景：14
- 失败场景：0
- 总成功率：100%
- 核心场景成功率：100%

## 对齐点对比
| 样本 | 格式组合 | dance对齐点 | bgm对齐点 | 与基准差异 |
|------|----------|-------------|-----------|------------|
| echo | MP4/MP4 | 13.40s | 5.70s | 基准 |
| echo | MOV/MP4 | 13.40s | 5.70s | 0.00s |
| ... | ... | ... | ... | ... |

## 输出时长对比
| 样本 | 格式组合 | 输出时长 | 与基准差异 |
|------|----------|----------|------------|
| echo | MP4/MP4 | 30.39s | 基准 |
| echo | MOV/MP4 | 30.39s | 0.00s |
| ... | ... | ... | ... |

## 结论
✅ 所有格式组合处理成功
✅ 对齐点与基准完全一致
✅ 输出时长与基准完全一致
✅ 格式兼容性验证通过
```

---

## 七、风险评估

### 7.1 潜在风险
- **某些格式不支持stream copy**：需要重新编码（但这种情况很少）
- **转换失败**：已实现兜底机制，使用原文件
- **时间轴差异**：stream copy理论上不会改变时间轴

### 7.2 风险缓解
- **兜底机制**：转换失败时使用原文件
- **详细日志**：记录所有转换和处理过程
- **结果验证**：严格对比基准测试结果

---

## 八、调整说明（根据实际使用场景）

### 8.1 调整内容
根据用户视频来源（iPhone、安卓手机、抖音、小红书），重点调整：

1. **格式优先级调整**：
   - ✅ MOV (H.264) - 最高优先级（iPhone拍摄）
   - ✅ MP4 (H.265) - 最高优先级（新安卓手机）
   - ✅ MP4 (压缩) - 高优先级（社交媒体下载）
   - ⚠️ AVI, MKV - 降为中优先级（兼容性测试）

2. **测试场景调整**：
   - ✅ 增加H.265编码测试（新安卓手机）
   - ✅ 增加压缩视频测试（社交媒体）
   - ✅ 重点测试iPhone + 安卓组合场景

3. **验证标准调整**：
   - ✅ 核心场景（12个）必须100%成功
   - ⚠️ 兼容性场景（2个）允许一定失败率

### 8.2 确认事项

请确认以下内容：
1. ✅ 测试格式选择（MOV H.264, MP4 H.265, 压缩MP4）是否符合实际场景？
2. ✅ 测试场景矩阵（14个场景，核心12个）是否足够？
3. ✅ 验证方法（对齐点、时长对比）是否合理？
4. ✅ 成功标准（核心场景100%，兼容性场景允许失败）是否可接受？

确认后开始实施代码和测试。

