# CDN CNAME 一键配置指南

> **当前状态**：域名已托管在 DNSPod，检测到现有 A 记录  
> **一键配置影响**：暂停现有 A 记录，添加 CDN CNAME 记录

---

## 一键配置的影响分析

### 当前 DNS 配置

**将被暂停的记录**：
1. **A 记录**：`@` → `124.221.58.149`（直接指向服务器）
2. **NS 记录**：`@` → `driver.dnspod.net.` 和 `hardy.dnspod.net.`

**将新增的记录**：
1. **CNAME 记录**：`@` → `beatsync.site.cdn.dnsv1.com`（指向 CDN）

---

## 配置后的效果

### ✅ 配置后的访问流程

```
用户访问 beatsync.site
    ↓
DNS 解析到 beatsync.site.cdn.dnsv1.com（CDN）
    ↓
CDN 节点提供服务（如果缓存中有）
    ↓
如果缓存中没有，CDN 回源到 124.221.58.149
    ↓
源站返回内容给 CDN
    ↓
CDN 缓存并返回给用户
```

### ⚠️ 重要变化

1. **域名不再直接指向服务器 IP**：
   - 之前：`beatsync.site` → `124.221.58.149`（直接访问）
   - 之后：`beatsync.site` → CDN → `124.221.58.149`（通过 CDN）

2. **源站仍然可以通过 IP 访问**：
   - CDN 回源需要访问 `124.221.58.149`
   - 源站服务不受影响

3. **用户访问通过 CDN**：
   - 用户访问 `beatsync.site` 会通过 CDN
   - 享受 CDN 加速和缓存

---

## 是否需要一键配置？

### ✅ 推荐使用一键配置

**理由**：
1. ✅ **简化操作**：自动完成 DNS 配置，无需手动操作
2. ✅ **配置正确**：CDN 已配置回源到 `124.221.58.149`，可以正常工作
3. ✅ **享受加速**：启用 CDN 加速，提升下载速度
4. ✅ **可逆操作**：如果出现问题，可以在 DNSPod 控制台恢复

### ⚠️ 注意事项

1. **短暂不可访问**：
   - DNS 变更需要时间生效（通常几分钟到几小时）
   - 期间可能导致网站短暂不可访问
   - 建议在业务低峰期操作

2. **确保 CDN 配置正确**：
   - 回源地址：`124.221.58.149` 或 `beatsync.site`
   - 回源 Host：`beatsync.site`
   - 回源协议：HTTPS

3. **源站仍然运行**：
   - 源站服务不受影响
   - CDN 会回源到源站获取内容

---

## 配置步骤

### 如果使用一键配置

1. **确认配置信息**：
   - 查看将被暂停的记录（A 记录指向 124.221.58.149）
   - 查看将新增的记录（CNAME 指向 beatsync.site.cdn.dnsv1.com）

2. **点击"确定"**：
   - 系统会自动暂停现有记录
   - 自动添加 CNAME 记录

3. **等待 DNS 生效**：
   - 通常需要几分钟到几小时
   - 可以通过"验证CNAME状态"按钮检查

4. **验证访问**：
   - 等待生效后，访问 `https://beatsync.site`
   - 检查是否通过 CDN 访问

---

## 验证配置

### 1. 检查 CNAME 状态

在 CDN 控制台：
- 点击"验证CNAME状态"按钮
- 等待状态变为"已生效"

### 2. 检查 DNS 解析

在本地终端：

```bash
# 检查 DNS 解析
nslookup beatsync.site

# 或使用 dig
dig beatsync.site

# 应该返回 CNAME 记录指向 beatsync.site.cdn.dnsv1.com
```

### 3. 测试访问

```bash
# 测试 HTTPS 访问
curl -I https://beatsync.site/api/health

# 检查响应头中的 CDN 标识
# 通常会有 X-Cache、X-Served-By 等头
```

---

## 如果遇到问题

### 问题 1：DNS 生效后无法访问

**可能原因**：
1. CDN 配置不正确（回源地址、回源 Host）
2. CDN 证书未配置
3. DNS 传播未完成

**解决方法**：
1. 检查 CDN 回源配置
2. 检查 CDN HTTPS 证书配置
3. 等待 DNS 完全生效

### 问题 2：需要恢复直接访问

**解决方法**：
1. 前往 DNSPod 控制台
2. 删除 CNAME 记录
3. 恢复 A 记录（`@` → `124.221.58.149`）

---

## 总结

### ✅ 推荐使用一键配置

**理由**：
1. ✅ 操作简单，自动完成
2. ✅ CDN 配置已正确，可以正常工作
3. ✅ 启用 CDN 加速，提升用户体验
4. ✅ 可逆操作，出现问题可以恢复

### ⚠️ 注意事项

1. **DNS 生效需要时间**（几分钟到几小时）
2. **期间可能短暂不可访问**
3. **建议在业务低峰期操作**

### 操作建议

**点击"确定"使用一键配置** ✅

---

**最后更新**：2025-12-16
