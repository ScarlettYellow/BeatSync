# 订阅系统 - 接下来的工作清单

## ✅ 已完成的工作

1. ✅ **免费体验功能**：前5次处理免费，已实现并通过测试
2. ✅ **每日处理次数上限**：已实现并通过测试
3. ✅ **数据库初始化**：`process_logs` 表已创建
4. ✅ **后端服务**：订阅系统核心功能已实现
5. ✅ **iOS App StoreKit 集成**：代码已完成，等待测试
6. ✅ **App Store Connect 配置**：产品已创建

---

## 🚀 接下来需要做的工作

### 优先级 1：iOS App 测试（高优先级）⭐

#### 1.1 本地测试（可以立即开始）

**目标**：使用 StoreKit Configuration File 进行本地测试，无需 App Store Connect

**步骤**：
1. 在 Xcode 中配置 StoreKit Testing
   - 打开项目：`cd ios/App && npx cap open ios`
   - **Product** → **Scheme** → **Edit Scheme**
   - 选择 **Run** → **Options**
   - 在 **StoreKit Configuration** 中选择 `Products.storekit`
   - 点击 **Close** 保存

2. 运行 App 并测试
   - 在 Xcode 中运行 App（模拟器或真机）
   - 测试产品列表获取
   - 测试购买流程 UI
   - 测试订阅状态查询
   - 测试恢复购买流程

**测试范围**：
- ✅ 产品列表获取
- ✅ 购买流程 UI
- ✅ 订阅状态查询
- ✅ 恢复购买流程
- ⚠️ 不能测试真实的收据验证（需要沙盒测试）

**预计时间**：1-2小时

---

#### 1.2 沙盒测试（需要 App Store Connect 审核通过后）

**目标**：使用 App Store Connect 沙盒环境进行完整测试

**前提条件**：
- ✅ App Store Connect 已配置
- ✅ 产品已创建
- ⏳ 等待 Apple Developer Program 审核通过（如果还在审核中）

**步骤**：
1. 创建沙盒测试账号
   - 在 App Store Connect 中创建沙盒测试员
   - 在设备上登录沙盒测试账号

2. 测试完整购买流程
   - 测试真实购买（使用沙盒账号）
   - 测试收据验证（后端 API）
   - 测试订阅状态更新
   - 测试下载次数增加

3. 测试各种场景
   - 基础版订阅购买
   - 高级版订阅购买
   - 下载次数包购买
   - 订阅续费
   - 订阅取消

**预计时间**：2-3小时

---

### 优先级 2：前端 UI 更新（中优先级）

#### 2.1 检查产品价格显示

**需要检查的文件**：
- `web_service/frontend/script.js` - 产品列表显示逻辑
- `web_service/frontend/index.html` - 静态价格显示（如有）

**需要更新的价格**：
- 基础版月付：**4.8元/月**（已更新为 4.9元？需要确认）
- 高级版月付：19.9元/月
- 10次包：5元
- 20次包：9元

**操作**：
1. 检查前端代码中的价格显示
2. 确保与后端配置一致
3. 更新产品列表（如需要）

**预计时间**：30分钟

---

#### 2.2 添加每日处理次数显示（可选）

**功能**：在前端显示用户的每日处理次数信息

**显示内容**：
- 今日剩余处理次数
- 每日处理次数上限
- 当前订阅类型

**实现位置**：
- 在订阅管理区域添加显示
- 或在状态区域添加提示

**预计时间**：1-2小时

---

### 优先级 3：端到端测试（中优先级）

#### 3.1 测试完整购买流程

**测试场景**：
1. 用户在 iOS App 中购买订阅
2. 后端验证收据
3. 用户下载次数增加
4. 用户可以使用新购买的下载次数

**测试步骤**：
1. 创建测试脚本或手动测试
2. 验证每个步骤是否正常
3. 记录测试结果

**预计时间**：1-2小时

---

#### 3.2 测试每日处理次数限制

**测试场景**：
1. 购买基础版订阅（每日10次上限）
2. 连续提交11次处理请求
3. 验证第11次返回429错误
4. 等待到第二天，验证限制重置

**测试步骤**：
1. 创建测试用户
2. 购买基础版订阅（或直接更新数据库）
3. 连续提交处理请求
4. 验证限制是否正确

**预计时间**：1小时

---

#### 3.3 测试免费体验功能

**测试场景**：
1. 创建新用户（未购买订阅）
2. 提交处理请求
3. 验证前5次可以免费处理
4. 验证第6次需要订阅

**状态**：✅ 已通过测试

---

### 优先级 4：生产环境部署（低优先级，测试完成后）

#### 4.1 数据库迁移

**步骤**：
1. 备份现有数据库
2. 运行数据库初始化脚本
3. 验证 `process_logs` 表已创建
4. 验证索引已创建

**预计时间**：30分钟

---

#### 4.2 代码部署

**步骤**：
1. 部署更新的代码到生产服务器
2. 重启后端服务
3. 验证服务正常运行
4. 检查错误日志

**预计时间**：30分钟

---

#### 4.3 环境变量配置

**需要配置的环境变量**：
```bash
export SUBSCRIPTION_ENABLED=true
export SUBSCRIPTION_DB_PATH=/path/to/subscription.db
export APP_STORE_SHARED_SECRET=your_production_secret
export ADMIN_TOKEN=your_production_admin_token
export JWT_SECRET_KEY=your_production_jwt_secret
```

**预计时间**：15分钟

---

## 📋 工作清单

### iOS App 测试
- [ ] 配置 StoreKit Configuration File
- [ ] 运行本地测试（产品列表获取）
- [ ] 运行本地测试（购买流程 UI）
- [ ] 运行本地测试（订阅状态查询）
- [ ] 运行本地测试（恢复购买）
- [ ] 创建沙盒测试账号（等待审核通过后）
- [ ] 运行沙盒测试（真实购买）
- [ ] 运行沙盒测试（收据验证）
- [ ] 运行沙盒测试（订阅状态更新）

### 前端 UI
- [ ] 检查产品价格显示
- [ ] 更新产品价格（如需要）
- [ ] 更新产品列表（如需要）
- [ ] 添加每日处理次数显示（可选）

### 端到端测试
- [ ] 测试完整购买流程
- [ ] 测试每日处理次数限制
- [ ] 测试免费体验功能（✅ 已完成）
- [ ] 测试订阅续费
- [ ] 测试订阅取消

### 生产环境部署
- [ ] 备份生产数据库
- [ ] 运行数据库迁移
- [ ] 部署代码更新
- [ ] 配置环境变量
- [ ] 重启生产服务
- [ ] 验证生产环境正常运行

---

## 🎯 建议的执行顺序

### 立即开始（今天）
1. **iOS App 本地测试** ⭐
   - 配置 StoreKit Configuration File
   - 运行本地测试
   - 验证基本功能

2. **检查前端价格显示**
   - 快速检查并更新（如需要）

### 等待审核通过后
3. **iOS App 沙盒测试**
   - 创建沙盒测试账号
   - 运行完整测试

4. **端到端测试**
   - 测试完整购买流程
   - 测试各种场景

### 测试完成后
5. **生产环境部署**
   - 数据库迁移
   - 代码部署
   - 环境变量配置

---

## 📚 相关文档

- `docs/subscription/IOS_TESTING_GUIDE.md` - iOS 测试详细指南
- `docs/subscription/APP_STORE_CONNECT_SETUP.md` - App Store Connect 配置指南
- `docs/subscription/UPDATE_COMPLETE.md` - 更新完成总结
- `docs/subscription/DAILY_PROCESS_LIMIT_IMPLEMENTATION.md` - 每日处理次数上限实现说明

---

## 💡 提示

1. **iOS App 本地测试可以立即开始**，无需等待 App Store Connect 审核
2. **前端价格检查**可以快速完成，建议先做
3. **端到端测试**可以在本地测试完成后进行
4. **生产环境部署**建议在所有测试通过后进行

---

**建议先从 iOS App 本地测试开始！** 🚀
