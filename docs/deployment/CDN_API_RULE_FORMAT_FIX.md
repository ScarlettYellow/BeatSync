# CDN API 接口规则格式修正

> **问题**：API 接口规则格式错误  
> **原因**："文件目录"类型不支持通配符 `*`  
> **解决**：使用正确的类型和格式

---

## 问题分析

### 当前错误配置

- **类型**：文件目录
- **内容**：`/api/*`
- **错误**：输入格式不正确

### 原因

"文件目录"类型通常不支持通配符 `*`，需要使用其他类型。

---

## 解决方案

### 方案 1：使用"全路径文件"类型（推荐）

**配置**：
- **类型**：**全路径文件** ⭐
- **内容**：`/api/*`
- **缓存选项**：不缓存（0 秒）

**说明**：
- "全路径文件"类型支持通配符 `*`
- 可以匹配 `/api/` 下的所有路径

---

### 方案 2：使用"文件目录"类型（精确路径）

如果"全路径文件"不可用，可以添加多个精确路径规则：

**规则 1**：
- **类型**：文件目录
- **内容**：`/api/upload`
- **缓存选项**：不缓存

**规则 2**：
- **类型**：文件目录
- **内容**：`/api/process`
- **缓存选项**：不缓存

**规则 3**：
- **类型**：文件目录
- **内容**：`/api/download`
- **缓存选项**：不缓存

**规则 4**：
- **类型**：文件目录
- **内容**：`/api/status`
- **缓存选项**：不缓存

**规则 5**：
- **类型**：文件目录
- **内容**：`/api/health`
- **缓存选项**：不缓存

**缺点**：需要为每个 API 路径添加规则，比较繁琐。

---

### 方案 3：使用正则表达式（如果支持）

某些 CDN 平台支持正则表达式：

- **类型**：全路径文件（或其他支持正则的类型）
- **内容**：`/api/.*` 或 `/api/.+`
- **缓存选项**：不缓存

---

## 推荐配置步骤

### 步骤 1：删除错误的规则

如果已创建错误的规则，先删除它。

### 步骤 2：添加正确的规则

1. 点击"新增规则"
2. **类型**：选择 **"全路径文件"** ⭐
3. **内容**：输入 `/api/*`
4. **缓存选项**：选择 **"不缓存"**（或设置为 0 秒）
5. 点击"确定"

### 步骤 3：验证规则

检查规则列表，确认：
- 规则已添加
- 类型为"全路径文件"
- 内容为 `/api/*`
- 缓存选项为"不缓存"

---

## 完整的缓存配置建议

### 节点缓存过期配置

| 规则 | 类型 | 内容 | 缓存行为 | 优先级 |
|------|------|------|----------|--------|
| 1 | 文件后缀 | `mp4;avi;mov;mkv` | 缓存 3-7 天 | 1 |
| 2 | **全路径文件** ⭐ | `/api/*` | **不缓存（0秒）** | 2 |
| 3 | 文件后缀 | `php;jsp;asp;aspx` | 不缓存 | 3 |

### 缓存键规则配置

| 规则 | 类型 | 内容 | 忽略参数 | 优先级 |
|------|------|------|----------|--------|
| 1 | **全路径文件** ⭐ | `/api/*` | **不忽略** | 1 |
| 2 | 文件后缀 | `mp4;avi;mov;mkv` | 全部忽略 | 2 |
| 3 | 文件后缀 | `css;js;jpg;png` | 全部忽略 | 3 |

---

## 如果"全路径文件"类型不可用

### 替代方案：使用"文件后缀"类型（不推荐）

如果只有"文件后缀"类型可用，无法直接匹配 `/api/*` 路径。

**建议**：
1. 不添加 API 接口的缓存规则（让默认规则处理）
2. 确保缓存键规则中，API 接口的参数不被忽略
3. 在源站（Nginx）层面设置 API 接口不缓存

**Nginx 配置示例**：
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8000;
    # 设置不缓存
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}
```

---

## 验证配置

配置完成后，测试：

```bash
# 测试 API 接口（应该不缓存）
curl -I "https://beatsync.site/api/health"

# 检查响应头
# 应该看到：Cache-Control: no-cache 或类似
```

---

## 常见问题

### Q1：为什么"文件目录"类型不支持 `/api/*`？

A：不同 CDN 平台对"文件目录"类型的定义不同，有些只支持精确路径，不支持通配符。

### Q2：如果所有类型都不支持通配符怎么办？

A：可以：
1. 添加多个精确路径规则（方案 2）
2. 在源站（Nginx）层面设置缓存控制
3. 联系 CDN 服务商确认支持的通配符格式

### Q3：如何确认规则是否生效？

A：
1. 在 CDN 控制台查看规则列表
2. 测试 API 接口，检查响应头中的缓存控制
3. 查看 CDN 日志，确认是否命中缓存

---

**最后更新**：2025-12-16
