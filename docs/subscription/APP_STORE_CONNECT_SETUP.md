# App Store Connect 配置指南

## 🎉 恭喜！App Store Connect 已开通

现在可以开始配置 App 内购买产品了。本指南将详细说明每一步操作。

---

## 📋 配置步骤总览

1. ✅ **创建 App**（如果还没有）
2. ✅ **创建 App 内购买产品**（7个产品）
3. ✅ **获取 App Store 共享密钥**
4. ✅ **创建沙盒测试账号**
5. ✅ **配置后端环境变量**
6. ✅ **进行沙盒测试**

---

## 步骤 1：创建 App（如果还没有）

### 1.1 登录 App Store Connect

1. 访问 [App Store Connect](https://appstoreconnect.apple.com)
2. 使用你的 Apple Developer 账号登录

### 1.2 创建新 App

1. 点击 **"我的 App"** → **"+"** → **"新建 App"**
2. 填写 App 信息：
   - **平台**：iOS
   - **名称**：BeatSync
   - **主要语言**：简体中文
   - **Bundle ID**：选择或创建 `com.beatsync.app`
   - **SKU**：`beatsync-app`（唯一标识符）
   - **用户访问权限**：完全访问权限

3. 点击 **"创建"**

### 1.3 记录重要信息

- **Bundle ID**：`com.beatsync.app`
- **App ID**：记录下系统生成的 App ID

---

## 步骤 2：创建 App 内购买产品

### 2.1 进入 App 内购买管理

1. 在 App Store Connect 中选择你的 App
2. 点击左侧菜单 **"功能"** → **"App 内购买项目"**
3. 点击 **"+"** → **"创建"**

### 2.2 创建订阅产品（4个）

#### 产品 1：基础版月付

1. **产品类型**：选择 **"自动续订订阅"**
2. **订阅组**：创建新组 "BeatSync Subscriptions"
3. **产品 ID**：`com.beatsync.subscription.basic.monthly`
4. **参考名称**：`基础版月付`
5. **订阅时长**：1 个月
6. **价格**：¥15.00（或选择对应价格等级）
7. **本地化信息**：
   - **显示名称**：`基础版月付`
   - **描述**：`每月100次高清下载，支持无限次处理`
8. **审核信息**（可选）：
   - **审核备注**：`这是订阅产品，用户每月可获得100次下载次数`
9. 点击 **"创建"**

#### 产品 2：基础版年付

1. **产品类型**：选择 **"自动续订订阅"**
2. **订阅组**：选择 "BeatSync Subscriptions"（与月付同一组）
3. **产品 ID**：`com.beatsync.subscription.basic.yearly`
4. **参考名称**：`基础版年付`
5. **订阅时长**：1 年
6. **价格**：¥99.00
7. **本地化信息**：
   - **显示名称**：`基础版年付`
   - **描述**：`每年1200次高清下载，支持无限次处理`
8. 点击 **"创建"**

#### 产品 3：高级版月付

1. **产品类型**：选择 **"自动续订订阅"**
2. **订阅组**：选择 "BeatSync Subscriptions"
3. **产品 ID**：`com.beatsync.subscription.premium.monthly`
4. **参考名称**：`高级版月付`
5. **订阅时长**：1 个月
6. **价格**：¥69.00
7. **本地化信息**：
   - **显示名称**：`高级版月付`
   - **描述**：`每月300次高清下载，支持无限次处理`
8. 点击 **"创建"**

#### 产品 4：高级版年付

1. **产品类型**：选择 **"自动续订订阅"**
2. **订阅组**：选择 "BeatSync Subscriptions"
3. **产品 ID**：`com.beatsync.subscription.premium.yearly`
4. **参考名称**：`高级版年付`
5. **订阅时长**：1 年
6. **价格**：¥499.00
7. **本地化信息**：
   - **显示名称**：`高级版年付`
   - **描述**：`每年3600次高清下载，支持无限次处理`
8. 点击 **"创建"**

### 2.3 创建一次性购买产品（3个）

#### 产品 5：10次下载包

1. **产品类型**：选择 **"非消耗型产品"**
2. **产品 ID**：`com.beatsync.pack.10`
3. **参考名称**：`10次下载包`
4. **价格**：¥5.00
5. **本地化信息**：
   - **显示名称**：`10次下载包`
   - **描述**：`一次性购买，获得10次下载次数`
6. 点击 **"创建"**

#### 产品 6：50次下载包

1. **产品类型**：选择 **"非消耗型产品"**
2. **产品 ID**：`com.beatsync.pack.50`
3. **参考名称**：`50次下载包`
4. **价格**：¥20.00
5. **本地化信息**：
   - **显示名称**：`50次下载包`
   - **描述**：`一次性购买，获得50次下载次数`
6. 点击 **"创建"**

#### 产品 7：100次下载包

1. **产品类型**：选择 **"非消耗型产品"**
2. **产品 ID**：`com.beatsync.pack.100`
3. **参考名称**：`100次下载包`
4. **价格**：¥35.00
5. **本地化信息**：
   - **显示名称**：`100次下载包`
   - **描述**：`一次性购买，获得100次下载次数`
6. 点击 **"创建"**

### 2.4 验证产品创建

**检查清单**：
- [ ] 4 个订阅产品已创建
- [ ] 3 个一次性购买产品已创建
- [ ] 所有产品 ID 与代码中的完全一致
- [ ] 所有产品状态为"准备提交"或"待处理"

**重要提示**：
- ⚠️ 产品创建后需要等待 Apple 审核（通常几分钟到几小时）
- ⚠️ 在审核通过前，产品可能无法在 App 中显示
- ⚠️ 产品 ID 必须与代码中的完全一致，否则无法获取产品列表

---

## 步骤 3：获取 App Store 共享密钥

### 3.1 进入密钥管理

1. 在 App Store Connect 中
2. 点击左侧菜单 **"用户和访问"** → **"密钥"**
3. 找到 **"App Store 共享密钥"** 部分

### 3.2 创建或查看共享密钥

1. 如果还没有共享密钥：
   - 点击 **"生成"** 或 **"创建"**
   - 系统会生成一个共享密钥
   - **重要**：立即复制并保存，只显示一次！

2. 如果已有共享密钥：
   - 点击 **"查看"** 或 **"显示"**
   - 复制共享密钥

### 3.3 保存共享密钥

**安全提示**：
- ✅ 将共享密钥保存在安全的地方
- ✅ 不要提交到代码仓库
- ✅ 使用环境变量存储
- ✅ 只给需要访问的人

**记录信息**：
- **共享密钥**：`_________________`（记录在这里，但不要提交到 Git）

---

## 步骤 4：创建沙盒测试账号

### 4.1 进入沙盒测试员管理

1. 在 App Store Connect 中
2. 点击左侧菜单 **"用户和访问"** → **"沙盒测试员"**

### 4.2 创建测试账号

1. 点击 **"+"** → **"新建沙盒测试员"**
2. 填写信息：
   - **名字**：`测试用户1`（或任意名称）
   - **姓氏**：`测试`
   - **电子邮件**：使用一个**未注册过 Apple ID 的邮箱**（例如：`test1@beatsync.test`）
   - **密码**：设置一个密码（至少8位，包含大小写字母和数字）
   - **国家或地区**：`中国`
   - **同意条款**：勾选

3. 点击 **"创建"**

### 4.3 创建多个测试账号（推荐）

**建议创建 2-3 个测试账号**：
- 测试账号 1：用于测试订阅购买
- 测试账号 2：用于测试一次性购买
- 测试账号 3：用于测试恢复购买

### 4.4 记录测试账号信息

**测试账号 1**：
- 邮箱：`_________________`
- 密码：`_________________`

**测试账号 2**：
- 邮箱：`_________________`
- 密码：`_________________`

---

## 步骤 5：配置后端环境变量

### 5.1 查看当前环境变量配置

检查后端服务使用的环境变量：

```bash
cd web_service/backend
cat .env  # 如果使用 .env 文件
# 或
env | grep SUBSCRIPTION
```

### 5.2 设置环境变量

**方法 1：使用 .env 文件（推荐）**

创建或编辑 `.env` 文件：

```bash
cd web_service/backend
nano .env  # 或使用其他编辑器
```

添加以下内容：

```bash
# 订阅系统配置
SUBSCRIPTION_ENABLED=true
SUBSCRIPTION_DB_PATH=./subscription.db

# JWT 配置
JWT_SECRET_KEY=your-secret-key-change-in-production

# 管理员配置
ADMIN_TOKEN=your-admin-token-here

# App Store 配置
APP_STORE_SHARED_SECRET=your_shared_secret_from_app_store_connect

# 后端 API 配置
BASE_URL=https://beatsync.site
```

**方法 2：使用环境变量（生产环境）**

在服务器上设置环境变量：

```bash
export SUBSCRIPTION_ENABLED=true
export APP_STORE_SHARED_SECRET=your_shared_secret_here
export ADMIN_TOKEN=your_admin_token
export JWT_SECRET_KEY=your_jwt_secret
```

### 5.3 重启后端服务

```bash
# 停止旧服务
pkill -f "python3 main.py"

# 启动新服务（带环境变量）
cd web_service/backend
python3 main.py
```

### 5.4 验证配置

检查后端日志，确认：
- ✅ 订阅系统已启用
- ✅ 数据库连接成功
- ✅ 环境变量已加载

---

## 步骤 6：在设备上配置沙盒测试

### 6.1 在 iOS 设备上登录沙盒账号

1. **退出当前 App Store 账号**（如果已登录）：
   - 进入 **设置** → **App Store**
   - 退出当前账号

2. **登录沙盒测试账号**：
   - 在 iOS 设备上运行你的 App
   - 当 App 尝试进行购买时，系统会提示登录
   - 使用你创建的沙盒测试账号登录

**注意**：
- ⚠️ 沙盒测试账号**不能**在 App Store 中登录
- ⚠️ 只能在 App 内购买时使用
- ⚠️ 沙盒测试账号的购买不会产生真实费用

### 6.2 测试购买流程

1. **运行 App**
2. **打开订阅管理**
3. **点击"查看订阅套餐"**
4. **选择产品并购买**
5. **使用沙盒账号完成购买**
6. **验证购买结果**

---

## 📋 配置检查清单

### App Store Connect 配置

- [ ] App 已创建
- [ ] Bundle ID 已配置：`com.beatsync.app`
- [ ] 4 个订阅产品已创建
  - [ ] `com.beatsync.subscription.basic.monthly`
  - [ ] `com.beatsync.subscription.basic.yearly`
  - [ ] `com.beatsync.subscription.premium.monthly`
  - [ ] `com.beatsync.subscription.premium.yearly`
- [ ] 3 个一次性购买产品已创建
  - [ ] `com.beatsync.pack.10`
  - [ ] `com.beatsync.pack.50`
  - [ ] `com.beatsync.pack.100`
- [ ] App Store 共享密钥已获取
- [ ] 沙盒测试账号已创建（至少 1 个）

### 后端配置

- [ ] `SUBSCRIPTION_ENABLED=true`
- [ ] `APP_STORE_SHARED_SECRET` 已设置
- [ ] `ADMIN_TOKEN` 已设置
- [ ] `JWT_SECRET_KEY` 已设置
- [ ] 后端服务已重启
- [ ] 数据库连接正常

### 测试准备

- [ ] 在设备上可以登录沙盒账号
- [ ] App 可以正常运行
- [ ] 产品列表可以加载
- [ ] 购买流程可以测试

---

## 🚀 下一步：开始测试

配置完成后，可以开始进行沙盒测试：

1. **测试产品列表获取**
2. **测试购买流程**
3. **测试收据验证**
4. **测试订阅状态查询**
5. **测试恢复购买**

详细测试步骤请参考：
- `docs/subscription/IOS_TESTING_GUIDE.md` - 完整测试指南
- `docs/subscription/IOS_TESTING_STEPS.md` - 详细测试步骤

---

## ⚠️ 常见问题

### Q1: 产品列表为空

**可能原因**：
- 产品还在审核中（需要等待几分钟到几小时）
- 产品 ID 不匹配
- Bundle ID 不匹配

**解决方法**：
1. 等待产品审核通过
2. 检查产品 ID 是否与代码中的完全一致
3. 检查 Bundle ID 是否正确

### Q2: 购买失败

**可能原因**：
- 沙盒账号未登录
- 产品未审核通过
- 网络问题

**解决方法**：
1. 确保在设备上登录了沙盒账号
2. 等待产品审核通过
3. 检查网络连接

### Q3: 收据验证失败

**可能原因**：
- App Store 共享密钥未配置
- 后端服务未运行
- 网络问题

**解决方法**：
1. 检查 `APP_STORE_SHARED_SECRET` 环境变量
2. 确保后端服务正在运行
3. 检查后端日志

---

**配置完成后，就可以开始测试了！** 🎉
