# 每日处理次数上限实现说明

## ✅ 已实现的功能

### 1. 数据库表
- ✅ 创建了 `process_logs` 表用于记录每日处理次数
- ✅ 表结构：
  - `id`: 主键
  - `user_id`: 用户ID
  - `task_id`: 任务ID
  - `process_date`: 处理日期（DATE类型）
  - `created_at`: 创建时间

### 2. 检查函数
- ✅ `get_user_subscription_type()`: 获取用户当前的订阅类型
- ✅ `get_daily_process_limit()`: 获取用户每日处理次数上限
- ✅ `get_today_process_count()`: 获取用户今日已处理次数
- ✅ `check_daily_process_limit()`: 检查用户是否超过每日处理次数上限
- ✅ `record_process()`: 记录一次处理请求

### 3. API 集成
- ✅ 在 `/api/process` 接口中添加了每日处理次数上限检查
- ✅ 在处理请求前检查是否超过上限
- ✅ 如果超过上限，返回 429 错误（Too Many Requests）
- ✅ 处理成功后记录处理次数

---

## 📋 每日处理次数上限规则

### 基础版月付
- **上限**：10次/天
- **产品ID**：`com.beatsync.public_beta.subscription.basic.monthly`

### 高级版月付
- **上限**：20次/天
- **产品ID**：`com.beatsync.public_beta.subscription.premium.monthly`

### 下载次数加油包
- **上限**：10次/天
- **产品ID**：`com.beatsync.public_beta.subscription.pack.10` 或 `pack.20`

### 免费体验
- **上限**：无限制（前5次处理免费）
- **说明**：在免费体验期间（前5次），不限制每日处理次数

### 白名单用户
- **上限**：无限制
- **说明**：白名单用户不受每日处理次数限制

---

## 🔍 实现细节

### 检查流程

1. **获取用户订阅类型**
   - 检查用户是否有有效的订阅
   - 检查用户是否有有效的购买包
   - 检查用户是否在免费体验期间

2. **确定每日处理次数上限**
   - 基础版：10次/天
   - 高级版：20次/天
   - 购买包：10次/天
   - 免费体验：无限制
   - 白名单：无限制

3. **检查今日已处理次数**
   - 查询 `process_logs` 表中今日的记录数
   - 按 `user_id` 和 `process_date` 查询

4. **判断是否允许处理**
   - 如果 `剩余次数 = 上限 - 已使用次数 > 0`，允许处理
   - 否则返回错误信息

5. **记录处理次数**
   - 处理请求提交成功后，记录到 `process_logs` 表
   - 记录 `user_id`、`task_id` 和 `process_date`

---

## ⚠️ 注意事项

### 1. 时间重置
- 每日处理次数在每天 00:00 自动重置
- 使用 `process_date` 字段（DATE类型）来区分不同日期

### 2. 错误处理
- 如果检查失败（数据库错误等），会降级处理，允许继续处理
- 如果记录失败，不影响处理流程

### 3. 订阅系统未启用
- 如果订阅系统未启用，不限制每日处理次数
- 返回 `limit: 999999` 表示无限制

### 4. 用户认证
- 每日处理次数检查需要用户Token
- 如果没有Token，不进行限制（向后兼容）

---

## 📊 API 响应示例

### 允许处理
```json
{
  "task_id": "xxx",
  "status": "pending",
  "message": "任务已提交，正在处理..."
}
```

### 超过上限
```json
{
  "detail": "今日处理次数已达上限（10次/天），请明天再试或升级套餐"
}
```
HTTP 状态码：429 (Too Many Requests)

---

## 🧪 测试建议

1. **测试基础版限制**
   - 购买基础版订阅
   - 连续提交11次处理请求
   - 第11次应该返回429错误

2. **测试高级版限制**
   - 购买高级版订阅
   - 连续提交21次处理请求
   - 第21次应该返回429错误

3. **测试购买包限制**
   - 购买10次或20次包
   - 连续提交11次处理请求
   - 第11次应该返回429错误

4. **测试免费体验**
   - 新用户（未购买订阅）
   - 应该可以无限制处理（前5次免费）

5. **测试时间重置**
   - 在一天内达到上限
   - 等待到第二天
   - 应该可以重新处理

---

**实现完成！** ✅
