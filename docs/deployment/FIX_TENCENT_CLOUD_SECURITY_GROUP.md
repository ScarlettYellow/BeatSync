# 修复腾讯云安全组配置

> **问题**：服务运行正常，但外部无法访问  
> **原因**：腾讯云安全组未开放443端口  
> **解决**：在腾讯云控制台配置安全组规则

---

## 诊断结果分析

### ✅ 服务状态正常

从诊断结果看到：
- ✅ **Nginx服务**：`active (running)`
- ✅ **443端口监听**：Nginx正在监听443端口
- ✅ **8000端口监听**：FastAPI正在监听8000端口
- ✅ **本地FastAPI连接**：`curl http://localhost:8000/api/health` 成功
- ✅ **本地Nginx HTTPS连接**：`curl -k https://localhost/api/health` 成功

### ❌ 问题所在

- ❌ **防火墙未启用**：`Firewall not enabled (skipping reload)`
- ❌ **外部无法访问**：很可能是腾讯云安全组未开放443端口

---

## 解决方案

### 步骤1：在腾讯云控制台配置安全组

**操作步骤**：

1. **登录腾讯云控制台**
   - 访问：https://console.cloud.tencent.com/

2. **进入轻量应用服务器**
   - 控制台 → 轻量应用服务器 → 服务器

3. **选择服务器实例**
   - 找到服务器：`VM-0-11-ubuntu` 或 IP：`124.221.58.149`
   - 点击服务器名称进入详情页

4. **进入防火墙/安全组配置**
   - 在服务器详情页，找到 **"防火墙"** 或 **"安全组"** 标签
   - 点击进入防火墙配置页面

5. **添加443端口规则**
   - 点击 **"添加规则"** 或 **"新建规则"**
   - 配置如下：
     - **类型**：`自定义`
     - **协议**：`TCP`
     - **端口**：`443`
     - **策略**：`允许`
     - **来源**：`0.0.0.0/0`（允许所有IP访问）
     - **备注**：`HTTPS访问`

6. **保存规则**
   - 点击 **"确定"** 或 **"保存"**

---

### 步骤2：验证安全组配置

**检查规则**：
- 确认443端口规则已添加
- 确认规则状态为"已启用"
- 确认策略为"允许"

---

### 步骤3：测试外部访问

**在本地浏览器中访问**：
```
https://beatsync.site/api/health
```

**预期结果**：
- ✅ 返回：`{"status":"healthy","timestamp":"..."}`
- ✅ 不再显示 `ERR_CONNECTION_CLOSED`

---

## 安全组配置参考

### 需要开放的端口

| 端口 | 协议 | 用途 | 来源 |
|------|------|------|------|
| **443** | TCP | HTTPS访问 | 0.0.0.0/0 |
| **80** | TCP | HTTP访问（自动重定向到HTTPS） | 0.0.0.0/0 |
| **22** | TCP | SSH访问（管理服务器） | 可选，建议限制为特定IP |

---

## 详细操作步骤（图文说明）

### 1. 进入服务器详情页

1. 登录腾讯云控制台
2. 进入 **轻量应用服务器**
3. 找到服务器实例（IP：124.221.58.149）
4. 点击服务器名称进入详情页

---

### 2. 找到防火墙配置

在服务器详情页中：
- 找到 **"防火墙"** 或 **"安全组"** 标签
- 点击进入防火墙配置页面

---

### 3. 添加443端口规则

在防火墙配置页面：
1. 点击 **"添加规则"** 或 **"新建规则"** 按钮
2. 填写规则信息：
   - **规则名称**：`HTTPS访问`
   - **协议端口**：`TCP:443`
   - **策略**：`允许`
   - **来源**：`0.0.0.0/0`（所有IP）
3. 点击 **"确定"** 保存

---

### 4. 验证规则

确认规则列表中：
- ✅ 443端口规则已添加
- ✅ 规则状态为"已启用"
- ✅ 策略为"允许"

---

## 如果找不到防火墙配置

### 方法1：通过安全组配置

如果服务器使用的是安全组（而不是轻量服务器的防火墙）：
1. 进入 **云服务器CVM** → **安全组**
2. 找到服务器关联的安全组
3. 点击安全组名称进入规则配置
4. 添加443端口入站规则

---

### 方法2：通过轻量服务器防火墙

如果使用的是轻量应用服务器：
1. 进入 **轻量应用服务器** → **防火墙**
2. 找到服务器实例
3. 点击 **"添加规则"**
4. 配置443端口规则

---

## 验证清单

- [ ] 在腾讯云控制台找到防火墙/安全组配置
- [ ] 添加了443端口规则（TCP，允许，0.0.0.0/0）
- [ ] 规则状态为"已启用"
- [ ] 在浏览器中访问 `https://beatsync.site/api/health` 成功
- [ ] 前端可以正常连接后端API

---

## 常见问题

### Q1：找不到防火墙配置入口

**A**：不同服务器类型配置入口不同：
- **轻量应用服务器**：服务器详情页 → 防火墙
- **云服务器CVM**：服务器详情页 → 安全组

---

### Q2：添加规则后仍然无法访问

**A**：
1. 确认规则已保存并启用
2. 等待几分钟让规则生效
3. 清除浏览器缓存后重试
4. 检查域名DNS解析是否正确

---

### Q3：是否需要开放80端口？

**A**：建议开放，因为：
- HTTP请求会自动重定向到HTTPS
- Let's Encrypt证书验证需要80端口

---

## 相关文档

- `docs/deployment/TROUBLESHOOT_BACKEND_CONNECTION.md` - 后端连接问题排查
- `docs/deployment/SSL_CERTIFICATE_DEPLOYMENT_SUCCESS.md` - SSL证书部署记录

---

**最后更新**：2025-12-04

