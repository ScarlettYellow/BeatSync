# 剩余工作清单

## 概述

在等待 Apple Developer Program 审核期间，可以完成以下工作，确保审核通过后能立即开始测试和部署。

## ✅ 已完成的工作

### 前端 UI 集成
- ✅ 订阅管理界面
- ✅ subscription.js 集成
- ✅ 订阅功能实现
- ✅ 样式优化
- ✅ 前端 UI 测试

### 后端基础功能
- ✅ 数据库设计
- ✅ 用户认证
- ✅ 白名单管理
- ✅ 下载次数检查
- ✅ 下载次数消费
- ✅ 免费试用1周逻辑

### 后端 API 完善
- ✅ 完善订阅详情查询 API
- ✅ 实现已使用次数统计
- ✅ 添加订阅历史查询 API
- ✅ 添加下载记录查询 API
- ✅ 修复 free_weekly 引用

## 📋 待完成工作

### 阶段 1：后端 API 完善（高优先级）

#### 1.1 完善订阅详情查询 API ✅
- [x] 实现获取用户订阅信息（`/api/subscription/status` 中的 TODO）
- [x] 查询用户当前活跃订阅
- [x] 返回订阅类型、状态、到期时间等信息
- [x] 修复 `free_weekly` 引用（改为 `free_trial`）

#### 1.2 实现已使用次数统计 ✅
- [x] 统计免费试用已使用次数
- [x] 统计订阅已使用次数
- [x] 统计购买次数包已使用次数
- [x] 在 API 响应中包含已使用次数

#### 1.3 添加订阅历史查询 API ✅
- [x] `GET /api/subscription/history` - 获取用户订阅历史
- [x] 支持分页查询
- [x] 返回订阅记录列表（包括已过期订阅）

#### 1.4 添加下载记录查询 API ✅
- [x] `GET /api/downloads/history` - 获取用户下载记录
- [x] 支持分页查询
- [x] 返回下载记录列表（任务ID、版本、时间、使用的次数类型等）

### 阶段 2：测试脚本创建（中优先级）

#### 2.1 端到端测试脚本 ⏳
- [ ] 模拟完整购买流程测试
- [ ] 测试用户注册 → 购买订阅 → 下载视频 → 消费次数
- [ ] 测试免费试用流程
- [ ] 测试白名单功能

#### 2.2 收据验证测试脚本 ⏳
- [ ] 模拟 iOS 收据验证流程
- [ ] 测试收据验证 API
- [ ] 测试订阅信息保存到数据库

### 阶段 3：文档完善（中优先级）

#### 3.1 用户使用指南 ⏳
- [ ] 订阅系统使用说明
- [ ] 如何注册和登录
- [ ] 如何购买订阅
- [ ] 如何查看订阅状态
- [ ] 常见问题解答

#### 3.2 管理员操作手册 ⏳
- [ ] 如何启用/禁用订阅系统
- [ ] 如何管理白名单
- [ ] 如何查看用户订阅情况
- [ ] 如何查看下载统计

### 阶段 4：其他优化（低优先级）

#### 4.1 错误处理优化 ⏳
- [ ] 统一错误响应格式
- [ ] 添加更详细的错误信息
- [ ] 优化异常处理逻辑

#### 4.2 性能优化 ⏳
- [ ] 数据库查询优化
- [ ] API 响应时间优化
- [ ] 添加缓存机制（可选）

## 🎯 推荐优先级

### 立即开始（最有价值）

1. **后端 API 完善**
   - 完善订阅详情查询（当前是 TODO，影响前端显示）
   - 修复 `free_weekly` 引用（代码一致性）
   - 实现已使用次数统计（用户体验）

2. **测试脚本创建**
   - 端到端测试脚本（确保功能完整性）
   - 收据验证测试脚本（iOS 集成前准备）

### 其次完成

3. **文档完善**
   - 用户使用指南
   - 管理员操作手册

## 📊 工作量估算

| 任务 | 预计时间 | 优先级 |
|------|----------|--------|
| 完善订阅详情查询 API | 1-2小时 | 高 |
| 修复 free_weekly 引用 | 30分钟 | 高 |
| 实现已使用次数统计 | 1小时 | 高 |
| 添加订阅历史查询 API | 1-2小时 | 中 |
| 添加下载记录查询 API | 1-2小时 | 中 |
| 端到端测试脚本 | 2-3小时 | 中 |
| 收据验证测试脚本 | 1-2小时 | 中 |
| 用户使用指南 | 1-2小时 | 低 |
| 管理员操作手册 | 1-2小时 | 低 |

## 下一步

建议立即开始：
1. **完善订阅详情查询 API**（修复 TODO，提升代码完整性）
2. **修复 free_weekly 引用**（代码一致性）

告诉我你的选择，我立即开始实施！
