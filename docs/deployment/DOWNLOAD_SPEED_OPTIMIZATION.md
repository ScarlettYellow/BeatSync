# 下载速度优化方案

> **问题**：视频下载速度慢（205MB文件需要1小时）

---

## 问题分析

**当前情况**：
- 服务器带宽：3M（上传/下载）
- 视频文件大小：约205MB
- 下载速度：约8.4MB/小时（第一个文件），约45.7MB/14分钟（第二个文件）
- 理论下载时间：205MB ÷ 3Mbps ≈ 9-10分钟（理想情况）

**实际下载时间**：
- 第一个文件：预计1小时（实际速度约3.4Mbps）
- 第二个文件：预计14分钟（实际速度约2.3Mbps）

**可能原因**：
1. **服务器带宽限制**：3M带宽是主要瓶颈
2. **视频文件过大**：205MB对于3M带宽来说较大
3. **网络延迟**：跨地区访问可能有延迟
4. **并发下载**：同时下载多个文件会分摊带宽
5. **没有使用CDN**：直接从服务器下载，没有加速

---

## 优化方案

### 方案1：优化视频文件大小（推荐，立即生效）

**目标**：减少视频文件大小，从而减少下载时间

**当前编码参数**：
- CRF：23（质量较高，文件较大）
- 编码器：libx264

**优化建议**：

#### 选项A：提高CRF值（降低质量，减小文件）

**修改编码参数**：
- 将CRF从23提高到28-30
- 文件大小可减少30-50%
- 质量略有下降，但通常可接受

**修改文件**：
- `beatsync_fine_cut_modular.py`
- `beatsync_badcase_fix_trim_v2.py`

**修改位置**：
```python
# 当前：-crf 23
# 修改为：-crf 28 或 -crf 30
cmd_trim += ['-c:v', 'libx264', '-preset', preset, '-crf', '28']
```

**预期效果**：
- 文件大小：205MB → 100-140MB
- 下载时间：1小时 → 30-40分钟
- 质量：略有下降，但通常可接受

---

#### 选项B：降低视频分辨率（如果原始分辨率很高）

**如果原始视频是4K或2K**：
- 可以降低到1080p或720p
- 文件大小可减少50-75%

**修改FFmpeg参数**：
```python
# 添加分辨率缩放
cmd += ['-vf', 'scale=1920:1080']  # 1080p
# 或
cmd += ['-vf', 'scale=1280:720']    # 720p
```

**预期效果**：
- 文件大小：205MB → 50-100MB
- 下载时间：1小时 → 15-30分钟
- 质量：分辨率降低，但清晰度可接受

---

#### 选项C：降低视频比特率

**设置固定比特率**：
```python
# 使用较低的比特率
cmd += ['-b:v', '2M']  # 2Mbps比特率
```

**预期效果**：
- 文件大小：205MB → 80-120MB
- 下载时间：1小时 → 25-35分钟
- 质量：比特率降低，但通常可接受

---

### 方案2：升级服务器带宽（成本较高）

**当前配置**：3M带宽

**升级选项**：
- 升级到5M：下载时间减少40%
- 升级到10M：下载时间减少70%
- 升级到20M：下载时间减少85%

**成本**：
- 需要查看腾讯云价格
- 通常每月增加几十到几百元

**适用场景**：
- 如果优化文件大小后仍不满意
- 如果预算允许

---

### 方案3：使用CDN加速（推荐，长期方案）

**使用腾讯云CDN**：
- 将视频文件缓存到CDN节点
- 用户从最近的CDN节点下载
- 下载速度可提升2-5倍

**配置步骤**：
1. 开通腾讯云CDN服务
2. 配置CDN域名
3. 将视频文件上传到CDN
4. 前端使用CDN地址下载

**成本**：
- CDN流量费用（按使用量计费）
- 通常比直接升级带宽更经济

**适用场景**：
- 长期使用
- 用户分布广泛
- 需要更好的用户体验

---

### 方案4：分片下载（技术实现）

**实现断点续传和分片下载**：
- 将大文件分成多个小片段
- 并行下载多个片段
- 支持断点续传

**优点**：
- 提高下载速度（多线程）
- 支持断点续传
- 更好的用户体验

**缺点**：
- 需要修改前端和后端代码
- 实现复杂度较高

---

## 推荐方案组合

### 短期方案（立即实施）

1. **优化视频文件大小**：
   - 将CRF从23提高到28
   - 预期文件大小减少30-40%
   - 下载时间减少30-40%

2. **检查并优化编码参数**：
   - 确保使用合适的preset（fast或medium）
   - 检查是否有不必要的编码步骤

### 中期方案（1-2周内）

1. **评估带宽升级**：
   - 如果优化后仍不满意
   - 考虑升级到5M或10M带宽

2. **实现CDN**：
   - 如果用户分布广泛
   - 如果预算允许

### 长期方案（1-3个月）

1. **全面优化**：
   - 视频编码参数优化
   - CDN加速
   - 带宽升级（如需要）

---

## 立即执行的优化步骤

### 步骤1：修改视频编码参数

**修改文件**：`beatsync_fine_cut_modular.py`

**找到编码参数位置**（大约在 `create_aligned_video` 函数中）：
```python
# 当前代码
cmd_trim += ['-c:v', 'libx264', '-preset', preset, '-crf', '23']
```

**修改为**：
```python
# 优化后（减小文件大小）
cmd_trim += ['-c:v', 'libx264', '-preset', preset, '-crf', '28']
```

**同样修改**：`beatsync_badcase_fix_trim_v2.py`

---

### 步骤2：测试优化效果

**重新处理一个视频**：
- 使用优化后的参数
- 比较文件大小
- 检查质量是否可接受

---

### 步骤3：部署更新

**如果效果满意**：
```bash
# 在服务器上更新代码
cd /opt/beatsync
git pull origin main

# 重启服务（如果需要）
sudo systemctl restart beatsync
```

---

## 预期效果对比

### 当前情况
- 文件大小：205MB
- 下载时间：1小时（第一个文件），14分钟（第二个文件）
- 下载速度：约3-4Mbps

### 优化后（CRF 28）
- 文件大小：约140MB（减少32%）
- 下载时间：约40分钟（第一个文件），10分钟（第二个文件）
- 下载速度：约3-4Mbps（不变，但文件更小）

### 优化后（CRF 28 + 带宽升级到5M）
- 文件大小：约140MB
- 下载时间：约25分钟（第一个文件），6分钟（第二个文件）
- 下载速度：约5Mbps

---

## 成本对比

### 方案1：优化文件大小（CRF 28）
- **成本**：免费
- **效果**：下载时间减少30-40%
- **推荐度**：⭐⭐⭐⭐⭐

### 方案2：升级带宽到5M
- **成本**：每月增加约50-100元
- **效果**：下载时间减少40%
- **推荐度**：⭐⭐⭐

### 方案3：使用CDN
- **成本**：按流量计费，约0.1-0.3元/GB
- **效果**：下载时间减少50-70%
- **推荐度**：⭐⭐⭐⭐

---

## 建议

**立即执行**：
1. 将CRF从23提高到28（减小文件大小30-40%）
2. 测试效果，确认质量可接受

**如果仍不满意**：
1. 考虑升级带宽到5M
2. 或使用CDN加速

**长期优化**：
1. 全面优化编码参数
2. 实现CDN加速
3. 考虑分片下载

---

**最后更新**：2025-12-02

