# CDN 缓存规则配置验证

> **当前状态**：配置已基本正确，但"全部文件"规则无法删除  
> **分析**：由于优先级机制，当前配置实际上是正确的

---

## 当前配置分析

### 节点缓存过期配置 ✅

| 规则 | 类型 | 内容 | 缓存行为 | 优先级 |
|------|------|------|----------|--------|
| 1 | 全路径文件 | `/api/.+` | 不缓存 | 1（最低） |
| 2 | 文件后缀 | `mp4;avi;mov;mkv` | 缓存3天 | 2 |
| 3 | 文件后缀 | `php;jsp;asp;aspx` | 不缓存 | 3（最高） |

**分析**：
- ✅ API 接口（`/api/.+`）设置为不缓存
- ✅ 视频文件缓存 3 天
- ✅ 动态文件不缓存
- ✅ 优先级设置正确（数字越大优先级越高）

### 缓存键规则配置 ✅

| 规则 | 类型 | 内容 | 忽略参数 | 优先级 |
|------|------|------|----------|--------|
| 1 | 全部文件 | 全部文件 | **全部忽略** | 1（最低） |
| 2 | 全路径文件 | `/api/.+` | **不忽略** | 2 |
| 3 | 文件后缀 | `mp4;avi;mov;mkv` | 全部忽略 | 3（最高） |

**关键点**：优先级规则
- 根据腾讯云 CDN 的说明："列表底部的优先级大于列表顶部"
- 规则 2（`/api/.+` 不忽略参数）的优先级（2）高于规则 1（全部文件 全部忽略，优先级1）
- 规则 3（视频文件 全部忽略）的优先级（3）最高

---

## 配置正确性验证

### ✅ API 接口参数不会被忽略

**原因**：
- 规则 2（`/api/.+` 不忽略参数）的优先级（2）高于规则 1（全部文件 全部忽略，优先级1）
- 因此，所有 `/api/` 路径的请求都会匹配规则 2，参数不会被忽略 ✅

**验证**：
```
请求：/api/download/123?version=modular
匹配：规则 2（优先级2，不忽略参数）✅
结果：参数被保留，缓存键包含 version=modular

请求：/api/download/123?version=v2
匹配：规则 2（优先级2，不忽略参数）✅
结果：参数被保留，缓存键包含 version=v2
```

### ✅ 视频文件参数会被忽略

**原因**：
- 规则 3（视频文件 全部忽略）的优先级（3）最高
- 视频文件请求会匹配规则 3，参数会被忽略 ✅

**验证**：
```
请求：/path/video.mp4?v=123
匹配：规则 3（优先级3，全部忽略参数）✅
结果：参数被忽略，缓存键不包含 v=123
```

---

## 关于"全部文件"规则无法删除

### 原因分析

"全部文件"规则可能是：
1. **系统默认规则**：CDN 平台的默认配置，不允许删除
2. **基础规则**：作为兜底规则，确保所有请求都有缓存键规则匹配
3. **平台限制**：某些 CDN 平台要求至少有一个"全部文件"规则

### 解决方案

**方案 1：修改规则（推荐）**

虽然无法删除，但可以修改：

1. 点击"全部文件"规则的"修改"按钮
2. 将"忽略参数"改为 **"不忽略"** 或 **"保留指定参数"**
3. 这样即使匹配到规则 1，参数也不会被忽略

**注意**：由于规则 2 的优先级更高，API 接口仍然会匹配规则 2，所以修改规则 1 主要是为了兜底。

**方案 2：保持现状（当前配置已正确）**

由于优先级机制，当前配置实际上是正确的：
- API 接口会匹配规则 2（不忽略参数）✅
- 视频文件会匹配规则 3（忽略参数）✅
- 其他文件会匹配规则 1（忽略参数，作为兜底）

**建议**：保持现状即可，无需修改。

---

## 配置验证清单

### ✅ 已正确配置

- [x] API 接口（`/api/.+`）设置为不缓存
- [x] API 接口的缓存键规则不忽略参数（规则 2）
- [x] 视频文件缓存 3 天
- [x] 视频文件的缓存键规则忽略参数（规则 3）
- [x] 优先级设置正确（规则 2 和 3 的优先级高于规则 1）

### ⚠️ 注意事项

- [ ] "全部文件"规则无法删除（系统限制，但不影响功能）
- [ ] 如果担心，可以修改"全部文件"规则为"不忽略参数"（作为兜底）

---

## 最终建议

### 当前配置状态：✅ 正确

**理由**：
1. API 接口的参数不会被忽略（规则 2 优先级更高）
2. 视频文件的参数会被忽略（规则 3 优先级最高）
3. 即使"全部文件"规则无法删除，也不影响功能

### 可选操作

如果希望更保险，可以：

1. **修改"全部文件"规则**：
   - 点击"修改"
   - 将"忽略参数"改为"不忽略"
   - 这样即使其他规则都不匹配，参数也不会被忽略

2. **保持现状**：
   - 当前配置已经正确
   - 优先级机制确保了正确的行为
   - 无需修改

---

## 测试验证

配置完成后，建议测试：

```bash
# 测试 API 接口（参数应该被保留）
curl -I "https://beatsync.site/api/download/123?version=modular"
curl -I "https://beatsync.site/api/download/123?version=v2"

# 应该返回不同的内容（或至少参数被保留在缓存键中）

# 测试视频文件（参数可以被忽略）
curl -I "https://beatsync.site/path/video.mp4?v=123"
curl -I "https://beatsync.site/path/video.mp4?v=456"

# 可能返回相同的缓存内容（参数被忽略）
```

---

## 总结

### 配置状态：✅ 正确

**关键点**：
1. ✅ API 接口参数不会被忽略（规则 2 优先级更高）
2. ✅ 视频文件参数会被忽略（规则 3 优先级最高）
3. ✅ 缓存行为配置正确
4. ⚠️ "全部文件"规则无法删除，但不影响功能

**建议**：
- 保持当前配置即可
- 如果担心，可以修改"全部文件"规则为"不忽略参数"（作为兜底）

---

**最后更新**：2025-12-16
