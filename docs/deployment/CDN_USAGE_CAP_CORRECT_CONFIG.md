# CDN 用量封顶配置修正

> **当前配置问题**：统计类型和阈值设置不适合 BeatSync 的业务场景  
> **需要修正**：改为累计用量，提高封顶阈值

---

## 当前配置分析

### ✅ 已修正的配置

1. **统计类型**：累计用量 ✅
   - **正确**：适合文件下载场景，按周期统计总流量

### ⚠️ 仍需修正的配置

1. **统计周期**：每小时
   - **问题**：周期太短，对于文件下载场景不合适
   - **建议**：改为"按天"
   - **影响**：每小时统计可能导致正常使用频繁触发封顶

2. **封顶阈值**：100 MB
   - **问题**：阈值太小，一个视频文件就可能超过
   - **建议**：改为 90 GB
   - **影响**：正常使用可能频繁触发封顶

3. **单位**：MB
   - **问题**：单位太小
   - **建议**：改为 GB

### ✅ 正确的配置

---

## 推荐配置（基于 100GB 流量包）

### 配置项

1. **统计类型**：**累计用量** ⭐（不是"瞬间用量"）
2. **统计周期**：**按天** ⭐（不是"每5分钟"）
3. **封顶配置**：**流量封顶**
4. **封顶阈值**：**90GB** ⭐（不是 100MB）
5. **单位**：**GB** ⭐（不是 MB）
6. **解封时间**：**永不解封**（可以保持）
7. **超出阈值**：**访问返回404**（可以保持）
8. **告警阈值**：**80%**（可以保持）

---

## 配置步骤

### 1. 修改统计类型

- **当前**：瞬间用量
- **改为**：**累计用量** ⭐

### 2. 修改统计周期

- **当前**：每5分钟
- **改为**：**按天** ⭐

### 3. 修改封顶阈值

- **当前**：100 MB
- **改为**：**90 GB** ⭐
- **单位**：选择 **GB**（不是 MB）

### 4. 其他配置（可以保持）

- **解封时间**：永不解封 ✅
- **超出阈值**：访问返回404 ✅
- **告警阈值**：80% ✅

---

## 配置说明

### 为什么选择"累计用量"？

**累计用量**：
- ✅ 适合文件下载场景
- ✅ 按天或按月统计总流量
- ✅ 不会因为单个大文件下载而误触发

**瞬间用量**（当前选择）：
- ❌ 每5分钟统计一次
- ❌ 可能导致正常的大文件下载触发封顶
- ❌ 不适合文件下载场景

### 为什么选择"按天"？

**按天**：
- ✅ 适合日常使用场景
- ✅ 每天重置统计，更灵活
- ✅ 可以更好地控制每日费用

**每5分钟**（当前选择）：
- ❌ 周期太短
- ❌ 可能导致正常使用频繁触发封顶

### 为什么设置 90GB？

**90GB**：
- ✅ 基于 100GB 流量包，留 10GB 缓冲
- ✅ 避免超出流量包后产生额外费用
- ✅ 足够应对正常的业务使用

**100MB**（当前选择）：
- ❌ 太小，一个视频文件就可能超过
- ❌ 会导致正常使用频繁触发封顶

---

## 完整配置示例

```
统计类型：累计用量 ⭐
统计周期：按天 ⭐
封顶配置：流量封顶
封顶阈值：90 GB ⭐
解封时间：永不解封
超出阈值：访问返回404（关闭CDN服务）
告警阈值：开启，80%
```

---

## 配置后的效果

1. **每日流量统计**：从每天 0:00 开始累计
2. **告警触发**：当日流量达到 72GB（90GB × 80%）时发送告警
3. **封顶触发**：当日流量超过 90GB 时，CDN 返回 404
4. **每日重置**：第二天 0:00 自动重置统计

---

## 注意事项

### ⚠️ 重要提示

1. **生效延迟**：配置生效需要约 10 分钟，期间产生的消耗会正常计费
2. **解封方式**：如果触发封顶，需要到域名管理页面手动重新上线域名
3. **告警通知**：确保已配置告警通知方式（短信/邮件），以便及时收到告警

---

## 总结

### ❌ 当前配置问题

- 统计类型：瞬间用量（应改为累计用量）
- 统计周期：每5分钟（应改为按天）
- 封顶阈值：100 MB（应改为 90 GB）

### ✅ 正确配置

- 统计类型：**累计用量**
- 统计周期：**按天**
- 封顶阈值：**90 GB**

---

**最后更新**：2025-12-16
