# 免费试用1周功能实现说明

## 概述

将免费体验套餐从"每周可免费下载2次"改为"免费试用1周"，新用户注册后获得7天试用期，试用期内提供50次免费下载。

## 实现细节

### 1. 数据库设计

- **用户表 (`users`)**：使用 `created_at` 字段记录用户注册时间
- **下载次数表 (`download_credits`)**：
  - `credit_type`: 从 `free_weekly` 改为 `free_trial`
  - `period_start`: 用户注册时间
  - `period_end`: 注册时间 + 7天
  - `total_credits`: 50次（试用期内）
  - `remaining_credits`: 剩余次数

### 2. 核心逻辑

#### 2.1 检查下载次数 (`check_download_credits`)

```python
# 1. 获取用户注册时间
user_created_at = get_user_created_at(user_id)

# 2. 计算试用期结束时间
trial_end = user_created_at + timedelta(days=7)

# 3. 检查是否在试用期内
if now < trial_end:
    # 在试用期内，提供50次免费下载
    free_trial_credits = 50
else:
    # 试用期已过期，没有免费下载
    free_trial_credits = 0
```

#### 2.2 消费下载次数 (`consume_download_credit`)

```python
# 优先级：免费试用期次数 > 购买次数 > 订阅次数

# 1. 检查是否在试用期内
if now < trial_end:
    # 使用免费试用期次数
    consume_free_trial_credit(user_id)
```

### 3. 关键变化

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 免费权益 | 每周可免费下载2次 | 免费试用1周（50次） |
| 重置机制 | 每周重置 | 基于注册时间，试用期7天 |
| 次数限制 | 每周2次 | 试用期内50次 |
| 有效期 | 每周重置 | 注册后7天内有效 |
| 数据库字段 | `free_weekly` | `free_trial` |

### 4. API 响应变化

#### 修改前
```json
{
  "available_credits": {
    "subscription": 0,
    "purchased": 0,
    "free_weekly": 2
  }
}
```

#### 修改后
```json
{
  "available_credits": {
    "subscription": 0,
    "purchased": 0,
    "free_trial": 50
  }
}
```

## 测试

### 运行测试脚本

```bash
cd web_service/backend
python3 test_free_trial.py
```

### 测试场景

1. **新用户注册后的试用期**
   - 新用户注册后应该获得50次免费试用
   - 试用期为注册后7天

2. **消费试用期下载次数**
   - 在试用期内可以消费下载次数
   - 每次消费后剩余次数正确递减

3. **已注册超过7天的用户**
   - 已注册超过7天的用户不应该有免费试用
   - 没有订阅的用户不能下载

4. **试用期过期后的行为**
   - 试用期过期后不能再使用免费试用次数
   - 需要订阅或购买才能继续下载

5. **多次消费**
   - 可以多次消费试用期下载次数
   - 剩余次数计算正确

## 注意事项

### 1. 现有用户处理

- **已注册用户**：试用期从注册时间开始计算（可能已过期）
- **新用户**：注册后自动获得7天试用期和50次免费下载

### 2. 数据库迁移

- **不需要迁移**：新逻辑会自动处理
- **向后兼容**：已存在的 `free_weekly` 记录不会影响新逻辑

### 3. 时区处理

- 使用 UTC 时间进行计算
- 确保 `created_at` 字段正确存储用户注册时间

### 4. 边界情况

- **注册时间解析失败**：降级使用当前时间
- **试用期边界**：精确到秒级别判断
- **并发消费**：数据库事务保证一致性

## 前端显示

前端已更新显示文本：
- 从"未订阅 | 每周可免费下载 2 次"
- 改为"未订阅 | 免费试用1周"

## 后续优化建议

1. **试用期提醒**：在试用期即将结束时提醒用户
2. **试用期延长**：考虑为特定用户延长试用期
3. **试用期统计**：统计试用期转化率
4. **试用期限制**：考虑限制试用期内的某些功能

