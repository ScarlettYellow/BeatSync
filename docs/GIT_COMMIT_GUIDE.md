# Git 版本管理指南

## 一、重要改动存档规则

### 1.1 必须提交的重要改动

以下类型的改动**必须**创建提交存档：

1. **核心功能改动**
   - 对齐算法修改
   - 音频处理逻辑变更
   - 视频处理流程调整

2. **性能优化**
   - 高分辨率视频优化
   - 内存优化
   - 缓存机制改进

3. **异常处理增强**
   - 新增异常处理机制
   - 错误处理逻辑改进
   - 输入验证增强

4. **格式兼容性**
   - 新增视频格式支持
   - 格式转换逻辑修改

5. **文档更新**
   - README.md 重大更新
   - 项目状态文档更新
   - API 文档变更

6. **工具模块**
   - beatsync_utils.py 新增功能
   - 测试脚本更新

### 1.2 提交信息格式

使用清晰的提交信息格式：

```
类型: 简短描述

详细说明（可选）：
- 改动内容1
- 改动内容2
- 影响范围

相关文件：
- file1.py
- file2.py
```

**类型前缀**：
- `feat:` - 新功能
- `fix:` - 修复bug
- `perf:` - 性能优化
- `refactor:` - 代码重构
- `docs:` - 文档更新
- `test:` - 测试相关
- `chore:` - 构建/工具相关

**示例**：
```
perf: 高分辨率视频处理优化

- 实现音频仅解码路径（-vn）
- 优先使用视频流复制（-c:v copy）
- 添加快速编码选项（x264 ultrafast）
- 性能提升：35s → 10-13s（2.7-3倍）

相关文件：
- beatsync_fine_cut_modular.py
- beatsync_badcase_fix_trim_v2.py
```

## 二、提交工作流

### 2.1 日常开发流程

```bash
# 1. 查看改动状态
git status

# 2. 查看具体改动
git diff

# 3. 添加要提交的文件
git add <文件或目录>

# 4. 创建提交
git commit -m "类型: 简短描述"

# 5. 查看提交历史
git log --oneline
```

### 2.2 重要改动存档流程

```bash
# 1. 确保所有改动已保存
git status

# 2. 添加所有相关文件
git add .

# 3. 创建详细的提交信息
git commit -m "类型: 简短描述" -m "详细说明..."

# 4. 查看提交
git log -1

# 5. 如果需要，创建标签标记重要版本
git tag -a v1.0.0 -m "版本说明"
```

## 三、分支管理（可选）

### 3.1 主分支策略

- **main/master**: 稳定版本，只接受经过测试的代码
- **develop**: 开发分支，用于日常开发
- **feature/xxx**: 功能分支，开发新功能时使用

### 3.2 创建功能分支

```bash
# 创建并切换到新分支
git checkout -b feature/新功能名称

# 开发完成后合并到主分支
git checkout main
git merge feature/新功能名称
```

## 四、回退操作

### 4.1 查看提交历史

```bash
# 简洁格式
git log --oneline

# 详细格式
git log

# 图形化显示
git log --graph --oneline --all
```

### 4.2 回退到指定提交

```bash
# 查看提交ID
git log --oneline

# 回退到指定提交（保留改动）
git reset --soft <commit-id>

# 回退到指定提交（丢弃改动）
git reset --hard <commit-id>

# 创建新提交回退（推荐，保留历史）
git revert <commit-id>
```

### 4.3 查看特定文件的历史

```bash
# 查看文件改动历史
git log -- <文件路径>

# 查看文件的具体改动
git diff <commit-id> -- <文件路径>

# 恢复文件到指定版本
git checkout <commit-id> -- <文件路径>
```

## 五、标签管理

### 5.1 创建标签

```bash
# 创建轻量标签
git tag v1.0.0

# 创建带注释的标签（推荐）
git tag -a v1.0.0 -m "版本1.0.0：高分辨率优化完成"

# 查看标签
git tag

# 查看标签详情
git show v1.0.0
```

### 5.2 重要版本标签建议

- `v1.0.0` - 初始稳定版本
- `v1.1.0` - 高分辨率优化版本
- `v1.2.0` - 格式兼容性版本
- `v1.3.0` - 异常处理增强版本

## 六、最佳实践

### 6.1 提交频率

- **重要功能完成时**：立即提交
- **测试通过后**：提交稳定版本
- **每日工作结束**：提交当日改动

### 6.2 提交粒度

- **一个提交一个功能**：不要将多个不相关的改动放在一个提交中
- **相关改动一起提交**：相关的文件改动应该一起提交

### 6.3 提交前检查

```bash
# 1. 检查改动
git status
git diff

# 2. 运行测试（如果有）
python3 test_exception_handling.py
python3 regression_test.py

# 3. 确认无误后提交
git add .
git commit -m "类型: 描述"
```

## 七、常用命令速查

```bash
# 初始化仓库（已完成）
git init

# 查看状态
git status

# 添加文件
git add <文件>
git add .  # 添加所有改动

# 提交
git commit -m "提交信息"

# 查看历史
git log
git log --oneline

# 查看改动
git diff
git diff --staged

# 回退
git reset --soft HEAD~1  # 回退提交，保留改动
git reset --hard HEAD~1  # 回退提交，丢弃改动
git revert <commit-id>   # 创建新提交回退

# 标签
git tag -a v1.0.0 -m "版本说明"
git tag  # 查看所有标签
```

## 八、重要改动检查清单

在提交重要改动前，确认：

- [ ] 代码已测试通过
- [ ] 相关文档已更新
- [ ] 提交信息清晰明确
- [ ] 没有包含临时文件或调试代码
- [ ] 改动不会影响现有功能（或已做兼容处理）

## 九、当前项目状态

**当前版本**: v1.3.0（异常处理增强版本）

**已完成的重要功能**：
- ✅ 高分辨率视频性能优化
- ✅ 视频格式兼容性
- ✅ 异常处理增强
- ✅ 内存监控和预警
- ✅ 缓存管理
- ✅ 文档完善

**建议标签**：
- `v1.0.0` - 初始稳定版本（并行处理器）
- `v1.1.0` - 高分辨率优化版本
- `v1.2.0` - 格式兼容性版本
- `v1.3.0` - 异常处理增强版本（当前）

