# 端到端测试指南

## 概述

端到端测试脚本 (`test_end_to_end.py`) 模拟完整的用户购买和使用流程，确保订阅系统的所有功能正常工作。

## 测试覆盖范围

### 1. 用户注册
- 新用户注册
- 获取用户 Token 和 User ID

### 2. 免费试用流程
- 检查免费试用状态（50次下载）
- 验证免费试用次数正确性

### 3. 模拟购买订阅
- 模拟购买 Basic Monthly 订阅（100次/月）
- 直接操作数据库添加订阅记录和下载次数

### 4. 模拟一次性购买
- 模拟购买 10次下载包
- 直接操作数据库添加购买记录和下载次数

### 5. 验证订阅状态
- 查询订阅状态 API
- 验证订阅信息、下载次数、已使用次数等

### 6. 消费下载次数
- 模拟多次下载（消费次数）
- 验证次数正确扣除
- 验证次数类型（免费试用、订阅、购买）

### 7. 白名单功能
- 添加用户到白名单
- 检查白名单状态
- 删除白名单用户

### 8. 查询订阅历史
- 查询用户所有订阅记录
- 验证分页功能

### 9. 查询下载记录
- 查询用户所有下载记录
- 验证分页功能

## 使用方法

### 前置条件

1. **启动后端服务**
   ```bash
   cd web_service/backend
   python main.py
   # 或
   uvicorn main:app --host 0.0.0.0 --port 8000
   ```

2. **设置环境变量**
   ```bash
   export SUBSCRIPTION_ENABLED=true
   export ADMIN_TOKEN=test_admin_token_12345
   export JWT_SECRET_KEY=test_jwt_secret_key_12345
   ```

3. **初始化数据库**
   ```bash
   python subscription_db.py
   ```

### 运行测试

```bash
cd web_service/backend
python test_end_to_end.py
```

### 预期输出

测试脚本会输出详细的测试步骤和结果：

```
======================================================================
  端到端测试 - 完整用户购买和使用流程
======================================================================

测试时间: 2025-01-XX XX:XX:XX
服务地址: http://localhost:8000

[1] 用户注册
----------------------------------------------------------------------
   ✅ 注册成功
   User ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   Token: xxxxxxxx...

[2] 免费试用流程
----------------------------------------------------------------------
   2.1 检查订阅状态（免费试用）
   ✅ 免费试用状态:
      总数: 50
      已使用: 0
      剩余: 50
   ✅ 免费试用次数正确（50次）

...

======================================================================
  测试结果汇总
======================================================================
用户注册: ✅ 通过
免费试用流程: ✅ 通过
模拟购买订阅: ✅ 通过
模拟一次性购买: ✅ 通过
验证订阅状态: ✅ 通过
消费下载次数: ✅ 通过
白名单功能: ✅ 通过
查询订阅历史: ✅ 通过
查询下载记录: ✅ 通过

总计: 9/9 通过

🎉 所有测试通过！
```

## 测试细节

### 模拟购买机制

由于实际购买需要 StoreKit 2 和 App Store Connect，测试脚本使用**直接操作数据库**的方式模拟购买：

1. **订阅购买** (`simulate_subscription_purchase`)
   - 插入 `subscriptions` 表记录
   - 插入 `download_credits` 表记录（类型为 `subscription`）
   - 根据订阅类型分配下载次数：
     - `basic_monthly`: 100次/月
     - `basic_yearly`: 1200次/年
     - `premium_monthly`: 300次/月
     - `premium_yearly`: 3600次/年

2. **一次性购买** (`simulate_one_time_purchase`)
   - 插入 `payment_records` 表记录
   - 插入 `download_credits` 表记录（类型为 `purchase`）
   - 根据产品ID分配下载次数：
     - `pack_10`: 10次
     - `pack_50`: 50次
     - `pack_100`: 100次

### 消费次数测试

测试脚本会模拟 5 次下载，验证：
- 次数正确扣除
- 优先使用免费试用次数
- 次数类型正确记录
- 下载记录正确保存

### 白名单测试

测试脚本会：
1. 添加用户到白名单
2. 检查白名单状态
3. 删除白名单用户

验证白名单功能的完整流程。

## 注意事项

1. **数据库操作**
   - 测试脚本会直接操作数据库，确保数据库已初始化
   - 测试数据会保留在数据库中（不会自动清理）

2. **服务状态**
   - 确保后端服务正在运行
   - 确保订阅系统已启用（`SUBSCRIPTION_ENABLED=true`）

3. **环境变量**
   - 确保所有必需的环境变量已设置
   - `ADMIN_TOKEN` 用于白名单管理测试

4. **测试隔离**
   - 每次运行测试会创建新的用户（基于时间戳）
   - 不会影响现有用户数据

## 故障排除

### 测试失败：用户注册失败
- 检查后端服务是否运行
- 检查 `SUBSCRIPTION_ENABLED` 环境变量
- 检查数据库是否已初始化

### 测试失败：模拟购买失败
- 检查数据库路径是否正确
- 检查数据库文件权限
- 检查数据库表结构是否正确

### 测试失败：API 请求超时
- 检查后端服务是否正常运行
- 检查网络连接
- 增加超时时间（修改脚本中的 `timeout` 参数）

## 下一步

完成端到端测试后，可以：

1. **创建收据验证测试脚本**
   - 测试 iOS 收据验证流程
   - 为 iOS App 集成做准备

2. **创建用户使用指南**
   - 文档化用户使用流程
   - 为上线做准备

3. **创建管理员操作手册**
   - 文档化管理操作
   - 便于系统管理
