# iOS App 订阅功能测试步骤

## ✅ 当前状态

- ✅ 订阅管理模块已显示在 App 界面
- ✅ HTML 文件已同步
- ✅ StoreKit Configuration File 已配置

---

## 🧪 测试步骤

### 步骤 1：验证订阅管理界面显示

**目标**：确认订阅管理区域正常显示

**操作**：
1. 在 App 中查看界面
2. 确认能看到：
   - ✅ "订阅管理" 标题
   - ✅ 订阅状态文本（应该显示 "未订阅 | 前5次处理免费"）
   - ✅ "查看订阅套餐" 按钮
   - ✅ "恢复购买" 按钮

**预期结果**：
- 订阅管理区域可见
- 所有按钮和文本正常显示

---

### 步骤 2：测试产品列表获取

**目标**：验证能否从 StoreKit 获取产品列表

**操作**：
1. 点击 "查看订阅套餐" 按钮
2. 观察产品列表是否显示
3. 在 Safari Web Inspector 中查看控制台日志

**预期结果**：
- 产品列表区域展开
- 显示 4 个产品：
  - 基础版月付：¥4.80/月
  - 高级版月付：¥19.90/月
  - 10次下载包：¥5.00
  - 20次下载包：¥9.00
- 控制台显示产品加载成功的日志

**如果失败**：
- 检查控制台错误信息
- 确认 StoreKit Configuration File 已正确配置
- 确认产品 ID 与 `Products.storekit` 中的一致

---

### 步骤 3：测试购买流程 UI

**目标**：验证购买按钮和购买流程 UI 是否正常

**操作**：
1. 在产品列表中，点击任意产品的 "购买" 按钮
2. 观察是否弹出购买确认对话框（StoreKit 购买界面）
3. 在购买对话框中：
   - 可以点击 "购买" 确认购买
   - 可以点击 "取消" 取消购买

**预期结果**：
- 点击购买按钮后，弹出 StoreKit 购买确认对话框
- 对话框中显示产品信息（名称、价格）
- 可以正常取消或确认购买

**注意**：
- 这是本地测试，购买不会产生真实费用
- 购买成功后，会显示在 StoreKit Configuration 的购买历史中

---

### 步骤 4：测试订阅状态查询

**目标**：验证订阅状态查询功能

**操作**：
1. 在 App 中查看订阅状态文本
2. 如果已购买订阅，状态应该更新
3. 在 Safari Web Inspector 中查看控制台日志

**预期结果**：
- 订阅状态文本正确显示：
  - 未订阅：显示 "未订阅 | 前5次处理免费"
  - 已订阅基础版：显示 "已订阅：基础版"
  - 已订阅高级版：显示 "已订阅：高级版"
- 控制台显示订阅状态查询的日志

---

### 步骤 5：测试恢复购买

**目标**：验证恢复购买功能

**操作**：
1. 点击 "恢复购买" 按钮
2. 观察是否有提示信息
3. 在 Safari Web Inspector 中查看控制台日志

**预期结果**：
- 点击后显示提示信息（成功或失败）
- 控制台显示恢复购买的日志
- 如果有之前的购买记录，应该能恢复

**注意**：
- 本地测试中，恢复购买可能没有历史记录
- 这是正常的，真实测试需要在沙盒环境中进行

---

### 步骤 6：测试购买后的状态更新

**目标**：验证购买后订阅状态是否正确更新

**操作**：
1. 完成一次购买（步骤 3）
2. 观察订阅状态文本是否更新
3. 重新打开 App，检查状态是否持久化

**预期结果**：
- 购买成功后，订阅状态立即更新
- 重新打开 App 后，状态仍然正确

---

## 📋 测试检查清单

### 基本功能
- [ ] 订阅管理区域正常显示
- [ ] "查看订阅套餐" 按钮正常工作
- [ ] 产品列表正确显示（4个产品）
- [ ] 产品价格正确显示
- [ ] 产品描述正确显示
- [ ] 购买按钮正常工作
- [ ] 购买流程 UI 正常（弹出购买对话框）
- [ ] 订阅状态查询正常
- [ ] "恢复购买" 按钮正常工作

### 产品验证
- [ ] 基础版月付：¥4.80/月
- [ ] 高级版月付：¥19.90/月
- [ ] 10次下载包：¥5.00
- [ ] 20次下载包：¥9.00

### 错误处理
- [ ] 购买取消处理正常
- [ ] 插件调用错误处理正常（如有）

---

## 🔍 调试技巧

### 查看控制台日志

在 Safari Web Inspector 中，应该能看到以下日志：

```
[主初始化] iOS App 环境，立即显示订阅区域
[主初始化] ✅ 订阅区域已强制显示
[订阅初始化] 开始初始化订阅功能...
[订阅初始化] 检测到 iOS App，立即显示订阅区域
[订阅元素] 获取订阅相关元素: ...
[订阅初始化] 订阅功能可用性: {available: true, ...}
```

### 检查元素

在控制台中执行：
```javascript
// 检查订阅区域是否存在
document.getElementById('subscription-section')

// 检查产品列表
document.getElementById('products-list')

// 检查订阅状态
document.getElementById('subscription-status')
```

### 检查 StoreKit 购买历史

在 Xcode 中：
1. **Window** → **StoreKit Transaction Manager**
2. 查看购买历史记录

---

## ⚠️ 已知限制

### 本地测试的限制

1. **收据验证**：
   - 本地测试无法验证真实收据
   - 需要沙盒测试才能验证后端收据验证 API

2. **订阅续费**：
   - 本地测试中，订阅不会自动续费
   - 需要手动在 StoreKit Configuration 中模拟续费

3. **恢复购买**：
   - 本地测试中，恢复购买可能没有历史记录
   - 这是正常的，真实测试需要在沙盒环境中进行

---

## 🎯 下一步

完成本地测试后：

1. ✅ **验证基本功能正常**（当前步骤）
2. ⏳ **等待 App Store Connect 审核通过**（如果还在审核中）
3. ⏳ **进行沙盒测试**（完整测试，包括收据验证）
4. ⏳ **端到端测试**（测试与后端的完整集成）

---

## 📚 相关文档

- `docs/subscription/IOS_LOCAL_TESTING_GUIDE.md` - iOS 本地测试详细指南
- `docs/subscription/NEXT_TASKS.md` - 接下来的工作清单
- `docs/subscription/SUBSCRIPTION_SYSTEM_DESIGN.md` - 订阅系统设计文档

---

**开始测试吧！按照步骤 1-6 逐步进行，并勾选检查清单中的项目。** 🚀


1. **收据验证**：
   - 本地测试无法验证真实收据
   - 需要沙盒测试才能验证后端收据验证 API

2. **订阅续费**：
   - 本地测试中，订阅不会自动续费
   - 需要手动在 StoreKit Configuration 中模拟续费

3. **恢复购买**：
   - 本地测试中，恢复购买可能没有历史记录
   - 这是正常的，真实测试需要在沙盒环境中进行

---

## 🎯 下一步

完成本地测试后：

1. ✅ **验证基本功能正常**（当前步骤）
2. ⏳ **等待 App Store Connect 审核通过**（如果还在审核中）
3. ⏳ **进行沙盒测试**（完整测试，包括收据验证）
4. ⏳ **端到端测试**（测试与后端的完整集成）

---

## 📚 相关文档

- `docs/subscription/IOS_LOCAL_TESTING_GUIDE.md` - iOS 本地测试详细指南
- `docs/subscription/NEXT_TASKS.md` - 接下来的工作清单
- `docs/subscription/SUBSCRIPTION_SYSTEM_DESIGN.md` - 订阅系统设计文档

---

**开始测试吧！按照步骤 1-6 逐步进行，并勾选检查清单中的项目。** 🚀


1. **收据验证**：
   - 本地测试无法验证真实收据
   - 需要沙盒测试才能验证后端收据验证 API

2. **订阅续费**：
   - 本地测试中，订阅不会自动续费
   - 需要手动在 StoreKit Configuration 中模拟续费

3. **恢复购买**：
   - 本地测试中，恢复购买可能没有历史记录
   - 这是正常的，真实测试需要在沙盒环境中进行

---

## 🎯 下一步

完成本地测试后：

1. ✅ **验证基本功能正常**（当前步骤）
2. ⏳ **等待 App Store Connect 审核通过**（如果还在审核中）
3. ⏳ **进行沙盒测试**（完整测试，包括收据验证）
4. ⏳ **端到端测试**（测试与后端的完整集成）

---

## 📚 相关文档

- `docs/subscription/IOS_LOCAL_TESTING_GUIDE.md` - iOS 本地测试详细指南
- `docs/subscription/NEXT_TASKS.md` - 接下来的工作清单
- `docs/subscription/SUBSCRIPTION_SYSTEM_DESIGN.md` - 订阅系统设计文档

---

**开始测试吧！按照步骤 1-6 逐步进行，并勾选检查清单中的项目。** 🚀
