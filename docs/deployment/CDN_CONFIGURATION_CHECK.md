# CDN 配置检查指南

> **域名**：beatsync.site  
> **用途**：加速视频文件下载

---

## 配置检查

### ✅ 正确的配置项

1. **加速域名**：`beatsync.site` ✓
2. **源站类型**：自有源 ✓
3. **回源协议**：HTTPS ✓
4. **源站地址**：`124.221.58.149` ✓

### ⚠️ 需要确认/修改的配置

1. **加速类型**：当前选择 "CDN 下载大文件"
   - **建议**：根据实际场景选择（见下方说明）

2. **端口**：当前未填写
   - **建议**：填写 `443`（HTTPS 默认端口）

3. **回源 Host**：需要确认
   - **建议**：填写 `beatsync.site`（与源站域名一致）

---

## 加速类型选择

### BeatSync 的业务场景

- **主要文件类型**：视频文件（MP4、MOV、AVI 等）
- **文件大小**：通常几 MB 到几百 MB
- **使用方式**：文件下载（不是流媒体点播）
- **访问模式**：用户上传视频 → 处理 → 下载处理后的视频

### 三种加速类型对比

#### 1. CDN 网页小文件
- **适用场景**：网页样式、图片、小文件（平均 < 5MB）
- **BeatSync 适用性**：❌ 不适用（视频文件通常 > 5MB）

#### 2. CDN 下载大文件 ⭐ **推荐**
- **适用场景**：大文件下载（平均 > 5MB），如游戏安装包、应用更新、应用程序包下载
- **BeatSync 适用性**：✅ **推荐**
- **理由**：
  - 视频文件通常较大（几 MB 到几百 MB）
  - 是文件下载场景，不是流媒体
  - 适合大文件传输优化

#### 3. CDN 音视频点播
- **适用场景**：在线音视频点播、流媒体播放
- **BeatSync 适用性**：⚠️ 可选（如果主要是视频文件）
- **理由**：
  - 虽然处理的是视频文件，但使用方式是下载，不是点播
  - 如果未来需要支持在线播放，可以选择此类型

---

## 推荐配置

### 加速类型
**推荐选择**：**"CDN 下载大文件"** ✅

**理由**：
1. BeatSync 主要提供视频文件下载服务
2. 视频文件通常较大（> 5MB）
3. 是文件下载场景，不是流媒体点播
4. 适合大文件传输优化

### 完整配置清单

```
加速域名：beatsync.site
加速类型：CDN 下载大文件 ⭐
IPv6访问：开启（可选）
所属项目：默认项目
源站类型：自有源
回源协议：HTTPS
源站地址：124.221.58.149
端口：443 ⚠️ 需要填写
回源 Host：beatsync.site ⚠️ 需要确认
```

---

## 配置步骤

### 1. 填写端口

在"源站地址"配置中：
- **端口**：填写 `443`（HTTPS 默认端口）

### 2. 配置回源 Host（重要）

在 CDN 配置中，需要设置"回源 Host"：
- **回源 Host**：`beatsync.site`
- **原因**：源站 Nginx 配置了 `server_name beatsync.site`，需要匹配

### 3. 提交配置

点击"添加"或"提交"按钮完成配置。

---

## 配置后的验证

### 1. 等待 CDN 生效

- CDN 配置通常需要 5-30 分钟生效
- 可以在 CDN 控制台查看配置状态

### 2. 配置 HTTPS 证书

在 CDN 控制台：
1. 进入域名配置 → "HTTPS配置"
2. 上传 SSL 证书（可以使用 Let's Encrypt 证书）
3. 开启 HTTPS 加速

### 3. 配置缓存规则

在 CDN 控制台：
1. 进入域名配置 → "缓存配置"
2. 配置视频文件缓存：
   - **文件类型**：`.mp4`, `.avi`, `.mov`, `.mkv`
   - **缓存时间**：7 天（或更长）
   - **忽略参数**：开启

3. 配置 API 接口（不缓存）：
   - **路径**：`/api/*`
   - **缓存时间**：0 秒（不缓存）

### 4. 测试 CDN 访问

```bash
# 测试 CDN 访问（等待生效后）
curl -I https://beatsync.site/api/health

# 检查响应头中的 CDN 标识
# 通常会有 X-Cache、X-Served-By 等头
```

---

## 注意事项

### 1. 回源 Host 配置

**非常重要**：如果源站 Nginx 配置了 `server_name beatsync.site`，CDN 回源时必须使用正确的 Host 头，否则可能无法正确访问。

### 2. CORS 配置

如果使用 CDN，需要确保后端 CORS 配置包含 CDN 域名：

```bash
# 在 .env 或 systemd 服务文件中
ALLOWED_ORIGINS=https://beatsync.site,http://localhost:8000
```

### 3. 缓存策略

- **视频文件**：设置较长缓存时间（7 天或更长）
- **API 接口**：不缓存（0 秒）
- **健康检查**：不缓存

---

## 总结

### 当前配置状态

- ✅ 加速域名：正确
- ✅ 源站类型：正确
- ✅ 回源协议：正确
- ✅ 源站地址：正确
- ⚠️ **加速类型**：当前选择 "CDN 下载大文件" - **推荐保持此选择** ✅
- ⚠️ **端口**：需要填写 `443`
- ⚠️ **回源 Host**：需要确认设置为 `beatsync.site`

### 建议操作

1. **保持加速类型**："CDN 下载大文件" ✅
2. **填写端口**：`443`
3. **配置回源 Host**：`beatsync.site`
4. **提交配置**
5. **等待生效后配置 HTTPS 和缓存规则**

---

**最后更新**：2025-12-16
