# 视频文件大小优化方案

> **问题**：输出视频文件太大，下载太慢

---

## 问题分析

**当前情况**：
- 输出视频文件：50MB左右
- 下载速度：3-4分钟
- 用户体验：等待时间过长

**原因**：
- 视频编码参数：CRF 23（中等质量）
- 没有压缩优化
- 没有预览/流媒体选项

---

## 解决方案

### 方案1：优化视频编码参数（推荐）

**降低CRF值，提高压缩率**

当前设置：`-crf 23`（中等质量，文件较大）
优化设置：`-crf 28`（较低质量，文件更小，但质量仍可接受）

**文件大小对比**：
- CRF 23：约50MB
- CRF 28：约20-30MB（减少40-50%）

**质量影响**：
- CRF 23：高质量（推荐用于最终输出）
- CRF 28：中等质量（文件更小，质量略有下降，但通常可接受）
- **注意**：CRF 28会有轻微的清晰度损失，但通常肉眼难以察觉。如果对质量要求很高，可以改回23或使用25作为折中方案

### 方案2：添加在线预览功能

**使用HTML5视频播放器**：
- 不下载完整文件
- 流媒体播放
- 边看边下载

### 方案3：生成低质量预览版本

**双版本输出**：
- 高质量版本（完整下载）
- 低质量预览版本（快速查看）

### 方案4：添加视频压缩选项

**用户可选择**：
- 高质量（大文件）
- 中等质量（中等文件）
- 低质量（小文件）

---

## 推荐方案：优化编码参数

### 修改编码参数

**文件**：`beatsync_fine_cut_modular.py` 和 `beatsync_badcase_fix_trim_v2.py`

**当前设置**：
```python
'-crf', '23'  # 中等质量
```

**优化设置**：
```python
'-crf', '28'  # 较低质量，文件更小
```

**预期效果**：
- 文件大小：减少40-50%
- 下载时间：减少40-50%
- 质量：仍然可接受

---

## 实施步骤

### 步骤1：修改编码参数

需要修改两个文件中的CRF值：
1. `beatsync_fine_cut_modular.py`
2. `beatsync_badcase_fix_trim_v2.py`

### 步骤2：测试效果

1. 处理测试视频
2. 对比文件大小
3. 检查视频质量

### 步骤3：部署更新

1. 提交代码更改
2. 更新服务器上的代码
3. 重启服务

---

## 其他优化建议

### 1. 降低分辨率（如果原始视频分辨率很高）

```python
'-vf', 'scale=1280:720'  # 降低到720p
```

### 2. 降低帧率（如果原始视频帧率很高）

```python
'-r', '25'  # 降低到25fps
```

### 3. 使用更快的编码预设

```python
'-preset', 'ultrafast'  # 最快编码（已在使用）
```

---

## 快速实施

**如果只想快速减小文件大小**：

修改CRF值从23到28，可以立即减少40-50%的文件大小。

**如果需要更好的用户体验**：

考虑添加在线预览功能，让用户可以在浏览器中直接观看，而不需要下载。

---

**最后更新**：2025-12-01

