# 高效调试流程指南

> **目的**：确保遇到问题时能快速定位和解决，避免浪费时间  
> **适用场景**：Web服务问题、API超时、请求失败等

---

## 一、标准调试流程（按顺序执行）

### 步骤1：查看日志（最重要！）

**不要先改代码，先看日志！**

1. **后端日志**（终端输出）
   ```bash
   # 查看后端运行的终端
   # 应该能看到请求日志、错误信息、处理步骤
   ```

2. **前端日志**（浏览器控制台）
   - 打开开发者工具（F12）
   - 查看 Console 标签
   - 查看 Network 标签（请求/响应详情）

3. **关键问题**：
   - ✅ 请求是否到达后端？（看后端日志是否有 `收到请求`）
   - ✅ 后端是否处理？（看后端日志是否有处理步骤）
   - ✅ 响应是否返回？（看前端 Network 标签的响应）

### 步骤2：根据日志定位问题

**如果后端没有收到请求**：
- 检查网络连接
- 检查后端服务是否运行
- 检查 CORS 配置
- 检查 API 地址是否正确

**如果后端收到请求但没有处理**：
- 查看后端日志的错误信息
- 检查是否有异常抛出
- 检查是否有阻塞操作

**如果后端处理了但没有返回响应**：
- 查看处理步骤日志，找到卡在哪一步
- 检查是否有同步阻塞操作
- 检查是否有死锁或资源竞争

### 步骤3：添加调试信息（如果需要）

**只在日志不够详细时才添加**：

1. **后端**：添加时间戳和步骤日志
   ```python
   import time
   start_time = time.time()
   print(f"INFO: [步骤X] 操作开始", file=sys.stderr, flush=True)
   # ... 执行操作 ...
   print(f"INFO: [步骤X] 操作完成 (耗时{time.time()-start_time:.3f}s)", file=sys.stderr, flush=True)
   ```

2. **前端**：添加请求/响应日志
   ```javascript
   console.log('📤 发送请求:', { url, method, body });
   const startTime = Date.now();
   const response = await fetch(url, options);
   console.log(`📥 收到响应 (耗时${Date.now()-startTime}ms):`, response.status);
   ```

### 步骤4：修复和验证

1. **修复问题**
2. **验证修复**：重新测试，查看日志确认
3. **记录修复**：更新文档，记录问题和解决方案

---

## 二、常见问题快速检查清单

### 超时问题

1. **检查超时设置**
   - 前端超时时间是否合理？
   - 是否应该根据操作类型动态调整？

2. **检查后端处理**
   - 是否有阻塞操作？
   - 是否应该异步化？

3. **检查网络**
   - 后端服务是否运行？
   - 网络连接是否正常？

### 请求失败问题

1. **检查后端服务**
   ```bash
   curl http://localhost:8000/api/health
   ```

2. **检查请求格式**
   - 查看前端 Network 标签的请求详情
   - 查看后端日志的请求信息

3. **检查错误响应**
   - 查看后端日志的错误信息
   - 查看前端控制台的错误信息

### 响应慢问题

1. **查看后端日志的耗时**
   - 哪个步骤最慢？
   - 是否有不必要的操作？

2. **检查阻塞操作**
   - 文件I/O是否同步？
   - 数据库操作是否阻塞？
   - 是否有锁竞争？

---

## 三、调试工具和命令

### 后端调试

```bash
# 检查服务是否运行
curl http://localhost:8000/api/health

# 查看进程
ps aux | grep uvicorn

# 查看端口占用
lsof -i :8000

# 测试API端点
curl -X POST http://localhost:8000/api/process \
  -F "dance_file_id=test" \
  -F "bgm_file_id=test"
```

### 前端调试

```javascript
// 浏览器控制台
// 1. 检查后端连接
fetch('http://localhost:8000/api/health')
  .then(r => r.json())
  .then(console.log)
  .catch(console.error)

// 2. 查看请求详情
// 打开 Network 标签，查看请求/响应
```

---

## 四、避免的低效做法

### ❌ 不要这样做

1. **不要盲目修改代码**
   - 先看日志，理解问题
   - 再修改代码

2. **不要过度依赖命令执行**
   - 命令可能超时或失败
   - 直接查看日志更高效

3. **不要跳过日志分析**
   - 日志是最重要的信息源
   - 跳过日志分析会浪费时间

4. **不要猜测问题**
   - 基于日志和证据分析
   - 不要凭感觉修改代码

### ✅ 应该这样做

1. **先看日志，再改代码**
2. **系统化排查**（网络 → 请求 → 处理 → 响应）
3. **添加调试信息**（只在必要时）
4. **验证修复效果**（重新测试，查看日志）

---

## 五、性能优化检查清单

### 后端响应优化

- [ ] 是否立即返回响应？（避免在响应前执行耗时操作）
- [ ] 耗时操作是否异步化？（文件I/O、数据库操作）
- [ ] 锁的持有时间是否尽可能短？
- [ ] 文件查找是否优化？（先尝试直接路径，避免 glob 扫描）

### 前端超时优化

- [ ] 超时时间是否合理？（根据操作类型和文件大小动态调整）
- [ ] 是否添加了健康检查？（关键操作前检查服务可用性）
- [ ] 错误提示是否明确？（提供具体的解决步骤）

### 日志和监控

- [ ] 关键步骤是否记录耗时？
- [ ] 日志格式是否统一？（便于分析）
- [ ] 错误信息是否详细？（便于定位问题）

---

## 六、快速参考

### 调试流程速查

```
问题出现
  ↓
1. 查看后端日志（终端）
  ↓
2. 查看前端日志（浏览器控制台）
  ↓
3. 根据日志定位问题
  ↓
4. 添加调试信息（如需要）
  ↓
5. 修复问题
  ↓
6. 验证修复（重新测试，查看日志）
```

### 关键问题速查

| 问题 | 检查点 | 解决方案 |
|------|--------|----------|
| 请求超时 | 后端是否收到请求？ | 查看后端日志 |
| 响应慢 | 哪个步骤最慢？ | 查看步骤耗时日志 |
| 请求失败 | 后端服务是否运行？ | `curl /api/health` |
| 无响应 | 是否卡在某个步骤？ | 查看步骤日志，找到卡点 |

---

## 七、记住这些原则

1. **日志优先**：先看日志，再改代码
2. **系统化排查**：按流程逐步排查，不要跳跃
3. **证据驱动**：基于日志和证据分析，不要猜测
4. **快速验证**：修复后立即验证，确保有效

---

**最后更新**：2025-11-27  
**适用场景**：所有Web服务调试问题














