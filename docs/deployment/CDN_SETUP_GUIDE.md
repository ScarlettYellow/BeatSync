# CDN加速配置指南

> **目的**：使用腾讯云CDN加速视频文件下载，提升用户体验

---

## 流量包确认

**您购买的流量包**：
- **产品**：CDN境内流量包 | 100GB | 1年
- **有效期**：1年
- **流量**：100GB

**是否可以直接使用**：
- ✅ **可以**！这个流量包就是用于CDN加速的
- 需要先开通CDN服务
- 然后配置CDN域名和加速规则
- 流量包会自动抵扣CDN流量费用

---

## CDN配置步骤

### 步骤1：开通CDN服务

**在腾讯云控制台操作**：

1. **登录腾讯云控制台**
   - 访问：https://console.cloud.tencent.com/

2. **进入CDN控制台**
   - 左侧菜单 → "内容分发网络 CDN"
   - 或者直接访问：https://console.cloud.tencent.com/cdn

3. **开通CDN服务**
   - 如果是首次使用，点击"开通CDN"
   - 选择计费方式（按流量计费）
   - 确认开通

---

### 步骤2：添加加速域名

**在CDN控制台操作**：

1. **点击"域名管理" → "添加域名"**

2. **填写域名信息**：
   - **加速域名**：
     - 如果有域名：`beatsync.example.com`（替换为您的域名）
     - 如果只有IP：需要使用域名（CDN需要域名，不能直接用IP）
   - **加速区域**：中国境内
   - **加速类型**：CDN网页小文件
   - **源站类型**：源站IP
   - **源站地址**：`124.221.58.149`
   - **回源协议**：HTTPS（443端口）

3. **点击"提交"**

---

### 步骤3：配置CDN加速规则

**配置缓存规则**：

1. **进入域名配置**
   - 点击域名 → "配置"

2. **配置缓存规则**：
   - **文件类型**：`.mp4`, `.avi`, `.mov` 等视频文件
   - **缓存时间**：7天（或更长）
   - **忽略参数**：开启（避免缓存重复）

3. **配置回源规则**：
   - **回源协议**：HTTPS
   - **回源Host**：`124.221.58.149`
   - **回源端口**：443

---

### 步骤4：配置HTTPS（如果使用域名）

**如果使用域名，需要配置SSL证书**：

1. **在CDN控制台配置HTTPS**
   - 进入域名配置 → "HTTPS配置"
   - 上传SSL证书（可以使用Let's Encrypt免费证书）
   - 开启HTTPS加速

---

### 步骤5：等待CDN生效

**CDN配置完成后**：
- 等待5-30分钟让CDN配置生效
- 可以通过CDN控制台查看配置状态

---

## 前端配置更新

### 更新下载地址为CDN地址

**文件**：`web_service/frontend/script.js`

**需要修改下载URL**：

**当前代码**（直接使用服务器地址）：
```javascript
const modularUrl = `${API_BASE_URL}/api/download/${result.task_id}?version=modular`;
```

**修改为**（使用CDN地址）：
```javascript
// CDN地址（如果配置了CDN）
const CDN_BASE_URL = 'https://beatsync.example.com'; // 替换为您的CDN域名

// 下载地址使用CDN
const modularUrl = `${CDN_BASE_URL}/api/download/${result.task_id}?version=modular`;
```

---

## 如果没有域名怎么办？

### 方案1：购买域名（推荐）

**购买域名**：
- 在腾讯云购买域名（如：`.com`, `.cn` 等）
- 价格：通常每年几十元

**配置DNS解析**：
- 将域名解析到服务器IP：`124.221.58.149`
- 在CDN中配置该域名

---

### 方案2：使用免费二级域名（临时方案）

**使用免费域名服务**：
- 如：Freenom, No-IP 等
- 配置DNS解析到服务器IP
- 在CDN中配置该域名

**注意**：免费域名可能不稳定，建议用于测试

---

### 方案3：使用腾讯云提供的测试域名（临时）

**腾讯云CDN可能提供测试域名**：
- 查看CDN控制台是否有测试域名选项
- 通常格式：`xxxxx.cdn.example.com`

---

## CDN配置详细步骤

### 完整配置流程

#### 1. 准备域名

**如果还没有域名**：
- 在腾讯云购买域名
- 或使用免费域名服务

**配置DNS解析**：
- 将域名A记录解析到：`124.221.58.149`
- 等待DNS生效（通常几分钟到几小时）

---

#### 2. 在CDN控制台添加域名

**操作步骤**：

1. **登录CDN控制台**
   - https://console.cloud.tencent.com/cdn

2. **添加域名**
   - 点击"域名管理" → "添加域名"
   - 填写：
     - **加速域名**：`beatsync.example.com`（您的域名）
     - **加速区域**：中国境内
     - **加速类型**：CDN网页小文件
     - **源站类型**：源站IP
     - **源站地址**：`124.221.58.149`
     - **回源协议**：HTTPS
     - **回源端口**：443

3. **提交并等待审核**（通常几分钟）

---

#### 3. 配置缓存规则

**进入域名配置**：

1. **点击域名 → "配置"**

2. **配置缓存规则**：
   - **文件类型**：`.mp4`, `.avi`, `.mov`, `.mkv`
   - **缓存时间**：7天
   - **忽略参数**：开启

3. **配置回源规则**：
   - **回源协议**：HTTPS
   - **回源Host**：`124.221.58.149`
   - **回源端口**：443

---

#### 4. 配置HTTPS（如果使用域名）

**在CDN控制台配置HTTPS**：

1. **进入域名配置 → "HTTPS配置"**

2. **上传SSL证书**：
   - 可以使用Let's Encrypt免费证书
   - 或使用腾讯云SSL证书

3. **开启HTTPS加速**

---

#### 5. 更新前端配置

**修改前端代码**：

```javascript
// 在 script.js 中
const CDN_BASE_URL = 'https://beatsync.example.com'; // 您的CDN域名

// 下载地址使用CDN
const modularUrl = `${CDN_BASE_URL}/api/download/${result.task_id}?version=modular`;
const v2Url = `${CDN_BASE_URL}/api/download/${result.task_id}?version=v2`;
```

**提交并推送**：
```bash
cd /Users/scarlett/Projects/BeatSync
git add web_service/frontend/script.js
git commit -m "feat: 使用CDN加速视频下载"
git push origin main
```

---

## 流量包使用说明

### 流量包抵扣规则

**您的流量包**：
- **类型**：CDN境内流量包
- **容量**：100GB
- **有效期**：1年

**使用方式**：
- CDN流量会自动从流量包中抵扣
- 超出流量包后，按量计费
- 可以在CDN控制台查看流量使用情况

**流量计算**：
- 每次下载视频文件，消耗的流量 = 文件大小
- 例如：下载一个140MB的视频，消耗140MB流量
- 100GB流量包可以支持约700次下载（假设每次140MB）

---

## 预期效果

### 下载速度提升

**使用CDN前**：
- 下载速度：3-4Mbps（服务器带宽限制）
- 下载时间：205MB文件约1小时

**使用CDN后**：
- 下载速度：10-50Mbps（取决于用户位置和CDN节点）
- 下载时间：205MB文件约3-10分钟
- **提升**：2-10倍

---

## 成本分析

### 流量包成本

**您已购买**：
- CDN境内流量包：100GB/年
- 成本：已包含在服务器套餐中

### 超出流量包后的费用

**如果超出100GB**：
- 按量计费：约0.15-0.3元/GB
- 建议监控流量使用情况

---

## 监控和管理

### 查看流量使用情况

**在CDN控制台**：
1. 进入"统计分析"
2. 查看流量使用情况
3. 查看流量包剩余量

### 设置流量告警

**建议配置**：
- 当流量使用达到80%时告警
- 避免超出流量包产生额外费用

---

## 故障排查

### 如果CDN不生效

1. **检查域名解析**
   ```bash
   nslookup beatsync.example.com
   ```

2. **检查CDN配置**
   - 确认域名已添加到CDN
   - 确认源站配置正确
   - 确认缓存规则已配置

3. **检查HTTPS配置**
   - 确认SSL证书已上传
   - 确认HTTPS已开启

---

## 验证清单

- [ ] 已购买域名（或使用免费域名）
- [ ] 域名DNS解析已配置
- [ ] CDN服务已开通
- [ ] CDN域名已添加
- [ ] CDN缓存规则已配置
- [ ] CDN回源规则已配置
- [ ] HTTPS已配置（如果使用域名）
- [ ] 前端配置已更新为CDN地址
- [ ] 测试下载速度是否提升

---

## 快速开始

**如果您已有域名**：

1. **配置DNS解析**：将域名解析到 `124.221.58.149`
2. **在CDN控制台添加域名**：使用您的域名
3. **配置缓存和回源规则**：按照上述步骤
4. **更新前端配置**：使用CDN域名
5. **测试下载速度**：应该明显提升

**如果您没有域名**：

1. **购买域名**：在腾讯云购买（推荐）
2. **或使用免费域名**：用于测试
3. **然后按照上述步骤配置**

---

**最后更新**：2025-12-02

