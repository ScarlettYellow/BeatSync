# CDN 缓存配置修正指南

> **问题**：当前缓存键规则配置可能导致 API 接口参数被错误忽略  
> **影响**：可能导致用户下载错误的视频版本

---

## 当前配置分析

### ✅ 正确的配置

1. **节点缓存过期配置**：
   - ✅ 视频文件（`mp4;avi;mov`）缓存 3 天
   - ✅ 动态文件（`php;jsp;asp;aspx`）不缓存

2. **优先级设置**：
   - ✅ 动态文件规则优先级更高（优先级2），确保动态内容不被缓存

### ⚠️ 需要修正的配置

**缓存键规则配置**：
- ❌ **全部文件** → **忽略参数：全部忽略**

**问题**：
BeatSync 的下载 URL 格式为：
```
/api/download/{task_id}?version=modular
/api/download/{task_id}?version=v2
```

如果忽略所有参数，会导致：
- `/api/download/123?version=modular` 和 `/api/download/123?version=v2` 被视为同一个缓存
- 用户请求 v2 版本时，可能得到缓存的 modular 版本 ❌

---

## 正确的配置方案

### 方案 1：按路径分别配置（推荐）

#### 1. 修改缓存键规则

删除当前的"全部文件"规则，添加以下规则：

**规则 1：API 接口（不忽略参数）**
- **类型**：文件路径
- **内容**：`/api/*`
- **忽略参数**：**不忽略** 或 **保留指定参数**（保留 `version` 参数）
- **忽略大小写**：是
- **优先级**：1（较低）

**规则 2：视频文件（可忽略参数）**
- **类型**：文件后缀
- **内容**：`mp4;avi;mov;mkv`
- **忽略参数**：全部忽略（视频文件的参数通常只是追踪用）
- **忽略大小写**：是
- **优先级**：2（较高）

**规则 3：其他静态文件（可忽略参数）**
- **类型**：文件后缀
- **内容**：`css;js;jpg;jpeg;png;gif;svg;ico;woff;woff2`
- **忽略参数**：全部忽略
- **忽略大小写**：是
- **优先级**：3（最高）

#### 2. 节点缓存过期配置（保持现有配置）

**规则 1：视频文件**
- **类型**：文件后缀
- **内容**：`mp4;avi;mov;mkv`
- **缓存行为**：缓存 3 天（或 7 天）
- **优先级**：1

**规则 2：API 接口（新增）**
- **类型**：文件路径
- **内容**：`/api/*`
- **缓存行为**：**不缓存**（0 秒）
- **优先级**：2（更高）

**规则 3：动态文件**
- **类型**：文件后缀
- **内容**：`php;jsp;asp;aspx`
- **缓存行为**：不缓存
- **优先级**：3（最高）

---

### 方案 2：简化配置（如果方案 1 不可用）

如果 CDN 不支持按路径配置忽略参数，可以：

1. **删除"全部文件"的忽略参数规则**
2. **只对视频文件设置忽略参数规则**

**缓存键规则配置**：
- **规则 1：视频文件**
  - **类型**：文件后缀
  - **内容**：`mp4;avi;mov;mkv`
  - **忽略参数**：全部忽略
  - **忽略大小写**：是

**注意**：这样配置后，API 接口的参数不会被忽略，但视频文件的参数会被忽略（通常可以接受）。

---

## 配置步骤

### 步骤 1：修改缓存键规则

1. 进入 CDN 控制台 → 域名配置 → 缓存配置
2. 找到"缓存键规则配置"
3. **删除**当前的"全部文件"规则
4. **添加新规则**（按方案 1 或方案 2）

### 步骤 2：添加 API 接口缓存规则

1. 在"节点缓存过期配置"中
2. **添加新规则**：
   - **类型**：文件路径
   - **内容**：`/api/*`
   - **缓存行为**：不缓存（0 秒）
   - **优先级**：设置为最高（确保 API 接口不被缓存）

### 步骤 3：验证配置

配置完成后，测试：

```bash
# 测试 API 接口（应该不缓存，且参数不被忽略）
curl -I "https://beatsync.site/api/download/123?version=modular"
curl -I "https://beatsync.site/api/download/123?version=v2"

# 应该返回不同的内容（或至少参数被保留）
```

---

## 推荐配置总结

### 节点缓存过期配置

| 规则 | 类型 | 内容 | 缓存行为 | 优先级 |
|------|------|------|----------|--------|
| 1 | 文件后缀 | `mp4;avi;mov;mkv` | 缓存 3-7 天 | 1 |
| 2 | 文件路径 | `/api/*` | **不缓存（0秒）** | 2 ⭐ |
| 3 | 文件后缀 | `php;jsp;asp;aspx` | 不缓存 | 3 |

### 缓存键规则配置

| 规则 | 类型 | 内容 | 忽略参数 | 优先级 |
|------|------|------|----------|--------|
| 1 | 文件路径 | `/api/*` | **不忽略** ⭐ | 1 |
| 2 | 文件后缀 | `mp4;avi;mov;mkv` | 全部忽略 | 2 |
| 3 | 文件后缀 | `css;js;jpg;png` | 全部忽略 | 3 |

---

## 为什么 API 接口不应该缓存？

1. **动态内容**：每个任务的视频文件都是动态生成的
2. **参数重要**：`version` 参数用于区分 modular 和 v2 版本
3. **实时性**：用户需要获取最新的处理结果
4. **安全性**：避免缓存敏感的任务 ID

---

## 验证清单

配置完成后，验证：

- [ ] API 接口（`/api/*`）设置为不缓存
- [ ] API 接口的缓存键规则不忽略参数
- [ ] 视频文件（`.mp4` 等）缓存 3-7 天
- [ ] 视频文件的缓存键规则可以忽略参数
- [ ] 测试下载不同版本（modular 和 v2）返回正确内容

---

**最后更新**：2025-12-16
