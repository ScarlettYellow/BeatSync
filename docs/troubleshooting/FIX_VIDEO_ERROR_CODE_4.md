# 修复视频预览错误代码4（MEDIA_ERR_SRC_NOT_SUPPORTED）

> **问题**：视频预览显示"错误代码: 4"，表示视频格式不支持

---

## 问题分析

### 错误代码4的含义

**MEDIA_ERR_SRC_NOT_SUPPORTED**：
- 浏览器无法识别或播放视频格式
- 可能是编码格式不兼容
- 可能是MIME类型设置问题
- 可能是视频文件本身的问题

---

## 可能原因

### 1. 旧视频文件（未使用faststart）

**问题**：
- 旧视频的moov atom在文件末尾
- 浏览器需要下载整个文件才能解析
- 可能导致格式检测失败

**解决**：
- 重新处理视频（新视频已优化）
- 或直接下载视频在本地播放

---

### 2. MIME类型设置过于严格

**问题**：
- 使用 `video/mp4; codecs="avc1.42E01E, mp4a.40.2"` 可能过于严格
- 某些浏览器可能不支持这种codecs字符串格式
- 导致格式检测失败

**解决**：
- 使用简单的 `video/mp4` MIME类型
- 让浏览器自动检测编码格式

---

### 3. Source标签的type属性

**问题**：
- `<source type="video/mp4; codecs=...">` 可能过于严格
- 某些浏览器可能不支持

**解决**：
- 使用简单的 `type="video/mp4"`
- 或移除source标签，直接使用src

---

## 实施的修复

### 1. 简化后端MIME类型

**改进前**：
```python
media_type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'
headers={"Content-Type": "video/mp4; codecs=\"avc1.42E01E, mp4a.40.2\""}
```

**改进后**：
```python
media_type='video/mp4'  # 使用简单的MIME类型
headers={"Content-Type": "video/mp4"}  # 避免codecs导致兼容性问题
```

**效果**：
- ✅ 更好的浏览器兼容性
- ✅ 让浏览器自动检测编码格式
- ✅ 减少格式检测失败

---

### 2. 简化前端Source标签

**改进前**：
```javascript
source.type = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"';
```

**改进后**：
```javascript
source.type = 'video/mp4'; // 使用简单的MIME类型，让浏览器自动检测编码
```

**效果**：
- ✅ 更好的浏览器兼容性
- ✅ 减少格式检测失败

---

### 3. 添加错误代码4的自动重试

**改进**：
- 检测到错误代码4时，自动移除source标签
- 直接使用src，重新加载
- 如果仍然失败，显示错误信息

**代码**：
```javascript
if (error?.code === 4) {
    console.log('🔄 检测到格式不支持错误，尝试移除source标签，直接使用src...');
    const source = videoPlayer.querySelector('source');
    if (source) {
        source.remove();
    }
    videoPlayer.src = videoUrl;
    videoPlayer.load(); // 重新加载
    return; // 不显示错误，等待重新加载结果
}
```

**效果**：
- ✅ 自动尝试修复格式问题
- ✅ 更好的用户体验

---

### 4. 优化错误提示信息

**改进**：
- 明确说明错误代码4的可能原因
- 提供具体的解决建议
- 区分旧视频和新视频

**效果**：
- ✅ 用户更容易理解问题
- ✅ 提供明确的解决方向

---

## 使用说明

### 对于旧视频

**问题**：
- 旧视频可能没有faststart优化
- 可能导致格式检测失败

**解决**：
1. **重新处理视频**（推荐）：
   - 上传新视频，重新处理
   - 新视频已优化，应该可以正常播放

2. **直接下载**：
   - 点击"下载视频"按钮
   - 在本地播放器打开

---

### 对于新视频

**预期**：
- 新视频已使用faststart优化
- 应该可以正常播放

**如果仍然失败**：
1. 检查网络连接
2. 尝试切换到WiFi
3. 清除浏览器缓存
4. 或直接下载视频

---

## 技术细节

### MIME类型选择

**简单MIME类型**：
- `video/mp4`：最兼容
- 让浏览器自动检测编码格式
- 适用于所有现代浏览器

**带codecs的MIME类型**：
- `video/mp4; codecs="avc1.42E01E, mp4a.40.2"`：更严格
- 某些浏览器可能不支持
- 可能导致格式检测失败

**建议**：
- 使用简单的 `video/mp4`
- 让浏览器自动检测编码格式

---

### 错误代码4的自动重试

**策略**：
1. 检测到错误代码4
2. 移除source标签
3. 直接使用src
4. 重新加载视频
5. 如果仍然失败，显示错误

**效果**：
- ✅ 自动尝试修复格式问题
- ✅ 更好的用户体验

---

## 验证方法

### 测试步骤

1. **处理一个新视频**：
   - 上传并处理一个新视频
   - 点击"在线预览"
   - 应该可以正常播放

2. **测试旧视频**：
   - 如果旧视频失败，这是正常的
   - 建议重新处理视频

3. **检查错误信息**：
   - 如果仍然失败，查看错误代码
   - 根据错误信息采取相应措施

---

## 总结

**修复内容**：
- ✅ 简化后端MIME类型设置
- ✅ 简化前端Source标签
- ✅ 添加错误代码4的自动重试
- ✅ 优化错误提示信息

**效果**：
- ✅ 更好的浏览器兼容性
- ✅ 自动尝试修复格式问题
- ✅ 更清晰的错误提示

**注意**：
- ⚠️ 旧视频可能需要重新处理
- ⚠️ 新视频应该可以正常播放

---

**最后更新**：2025-12-02

