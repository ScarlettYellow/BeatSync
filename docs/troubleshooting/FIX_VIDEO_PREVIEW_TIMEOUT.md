# 修复视频预览加载超时问题

> **问题**：在线预览视频加载失败，错误代码TIMEOUT

---

## 问题分析

### 可能原因

1. **超时时间过短**
   - 当前设置为30秒
   - 大文件（>100MB）可能需要更长时间
   - 慢速网络（4G、弱信号）需要更长时间

2. **视频文件较大**
   - 处理后的视频文件可能较大
   - 需要加载更多数据才能播放

3. **网络延迟**
   - 从GitHub Pages到腾讯云服务器
   - 手机网络可能较慢

4. **Range请求优化不足**
   - 浏览器需要先加载元数据
   - 如果Range请求不优化，可能较慢

---

## 解决方案

### 方案1：渐进式超时策略（已实施）

**策略**：
- 第一次：60秒超时
- 如果超时，自动重试，90秒超时
- 如果仍然超时，再次重试，120秒超时

**优势**：
- ✅ 给大文件和慢速网络更多时间
- ✅ 自动重试，无需用户操作
- ✅ 适应不同网络环境

---

### 方案2：优化视频预加载策略

**改进**：
- 从`preload="metadata"`改为`preload="auto"`
- 允许浏览器预加载更多数据
- 提升播放体验

---

### 方案3：添加加载进度显示

**改进**：
- 监听`progress`事件
- 显示加载进度
- 让用户了解加载状态

---

### 方案4：优化后端Range请求支持

**改进**：
- 明确指定`Content-Length`头部
- 帮助浏览器优化Range请求
- 提升加载速度

---

## 实施的修复

### 1. 渐进式超时策略

**改进前**：
```javascript
// 固定30秒超时
setTimeout(() => {
    if (isLoading) {
        showError({ code: 'TIMEOUT' }, videoUrl);
    }
}, 30000);
```

**改进后**：
```javascript
// 渐进式超时：60秒、90秒、120秒
const timeoutStrategies = [60000, 90000, 120000];

// 如果超时，自动重试并增加超时时间
if (timeoutAttempt < timeoutStrategies.length) {
    // 自动重试
    videoPlayer.src = videoUrl;
    setupTimeout(); // 重新设置超时
}
```

**效果**：
- ✅ 给大文件更多时间（60-120秒）
- ✅ 自动重试，无需用户操作
- ✅ 适应不同网络环境

---

### 2. 优化视频预加载

**改进**：
- `preload="metadata"` → `preload="auto"`
- 允许浏览器预加载更多数据
- 提升播放体验

---

### 3. 添加加载进度

**改进**：
- 监听`progress`事件
- 在控制台显示加载进度
- 帮助诊断问题

---

### 4. 优化后端响应

**改进**：
- 明确指定`Content-Length`头部
- 帮助浏览器优化Range请求
- 提升加载速度

---

## 使用说明

### 自动重试机制

**工作流程**：
1. 第一次尝试：60秒超时
2. 如果超时，自动重试：90秒超时
3. 如果仍然超时，再次重试：120秒超时
4. 如果所有重试都失败，显示错误

**用户无需操作**：
- ✅ 自动重试
- ✅ 逐步增加超时时间
- ✅ 适应不同网络环境

---

### 如果仍然失败

**建议**：
1. **检查网络**：
   - 确保网络连接正常
   - 尝试切换到WiFi

2. **直接下载**：
   - 点击"下载视频"按钮
   - 下载后在本地播放器打开

3. **检查文件大小**：
   - 如果文件很大（>200MB），可能需要更长时间
   - 考虑优化视频编码参数

---

## 技术细节

### 超时策略

**三次尝试**：
- 第1次：60秒（适应大多数情况）
- 第2次：90秒（给慢速网络更多时间）
- 第3次：120秒（适应极端情况）

**总等待时间**：
- 最多：60 + 90 + 120 = 270秒（4.5分钟）
- 但通常第一次或第二次就会成功

---

### Range请求优化

**后端改进**：
- 明确指定`Content-Length`
- 帮助浏览器计算Range请求
- 提升加载效率

---

## 测试建议

### 测试场景

1. **不同文件大小**：
   - 小文件（<50MB）：应该快速加载
   - 中等文件（50-100MB）：可能需要60秒
   - 大文件（>100MB）：可能需要90-120秒

2. **不同网络环境**：
   - WiFi：应该快速加载
   - 4G/5G：可能需要更长时间
   - 弱信号：可能需要多次重试

---

## 总结

**修复内容**：
- ✅ 渐进式超时策略（60秒、90秒、120秒）
- ✅ 自动重试机制
- ✅ 优化视频预加载
- ✅ 添加加载进度显示
- ✅ 优化后端Range请求支持

**效果**：
- ✅ 给大文件和慢速网络更多时间
- ✅ 自动重试，无需用户操作
- ✅ 更好的用户体验
- ✅ 更高的成功率

**如果仍然失败**：
- 检查网络连接
- 尝试切换到WiFi
- 或直接下载视频

---

**最后更新**：2025-12-02

