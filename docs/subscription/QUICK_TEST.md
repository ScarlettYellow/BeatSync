# 订阅系统快速测试指南

## 🚀 快速开始

### 1. 安装依赖
```bash
cd web_service/backend
pip3 install -r requirements.txt
```

### 2. 运行基础测试（验证零耦合）
```bash
cd web_service/backend
python3 test_subscription.py
```

**预期结果**：
- ✅ 数据库初始化：通过
- ✅ 用户创建：跳过（订阅系统未启用）
- ✅ 白名单功能：跳过（订阅系统未启用）
- ✅ 下载次数检查：跳过（订阅系统未启用）

**这证明了零耦合设计**：订阅系统关闭时，不影响现有功能。

### 3. 运行完整测试（启用订阅系统）
```bash
cd web_service/backend
SUBSCRIPTION_ENABLED=true \
ADMIN_TOKEN=test_admin_token_12345 \
JWT_SECRET_KEY=test_jwt_secret_key_12345 \
python3 test_subscription.py
```

**预期结果**：
- ✅ 数据库初始化：通过
- ✅ 用户创建：通过（创建用户并生成 Token）
- ✅ 白名单功能：通过（添加、检查、删除白名单）
- ✅ 下载次数检查：通过（检查免费周次数）

## 📋 测试结果示例

### 基础测试（订阅系统关闭）
```
==================================================
订阅系统基础功能测试
==================================================
测试1: 数据库初始化...
✅ 数据库初始化成功

测试2: 用户创建...
⚠️  订阅系统未启用，跳过测试

测试3: 白名单功能...
⚠️  订阅系统未启用，跳过测试

测试4: 下载次数检查...
⚠️  订阅系统未启用，跳过测试

==================================================
测试结果汇总
==================================================
数据库初始化: ✅ 通过
用户创建: ✅ 通过
白名单功能: ✅ 通过
下载次数检查: ✅ 通过

总计: 4/4 通过

🎉 所有测试通过！
```

### 完整测试（订阅系统启用）
```
==================================================
订阅系统基础功能测试
==================================================
测试1: 数据库初始化...
✅ 数据库初始化成功

测试2: 用户创建...
✅ 用户创建成功: c77cf9cd-ead8-48d3-8c14-ac101c57e36b

测试3: 白名单功能...
✅ 用户已添加到白名单: ada16c8e-39eb-41de-b340-40ecea0e1495
✅ 白名单检查成功
✅ 用户已从白名单删除
✅ 删除后检查成功

测试4: 下载次数检查...
✅ 下载次数检查成功:
   - 白名单: False
   - 可下载: True
   - 剩余次数: 2

==================================================
测试结果汇总
==================================================
数据库初始化: ✅ 通过
用户创建: ✅ 通过
白名单功能: ✅ 通过
下载次数检查: ✅ 通过

总计: 4/4 通过

🎉 所有测试通过！
```

## 🔍 验证数据库

```bash
# 查看数据库文件
ls -lh data/subscription.db

# 查看表结构
sqlite3 data/subscription.db ".tables"

# 查看用户表
sqlite3 data/subscription.db "SELECT * FROM users LIMIT 5;"

# 查看白名单表
sqlite3 data/subscription.db "SELECT * FROM whitelist;"

# 查看下载次数表
sqlite3 data/subscription.db "SELECT * FROM download_credits LIMIT 5;"
```

## ✅ 测试检查清单

- [x] 数据库初始化成功
- [x] 订阅系统关闭时，不影响现有功能（零耦合）
- [x] 订阅系统启用时，用户创建正常
- [x] 白名单添加/删除/检查正常
- [x] 下载次数检查正常（免费周次数自动初始化）

## 🎯 下一步

完成基础测试后，可以：
1. 测试 API 端点（见 `TESTING_GUIDE.md`）
2. 测试下载接口的向后兼容性
3. 开始 iOS App 集成
