# 处理失败排查指南

## 问题描述

视频上传成功，但点击"开始处理"后显示"处理失败"。

## 可能的原因

### 1. Render免费层超时限制 ⭐ **最常见**

**问题**：
- Render免费层的HTTP请求有超时限制（通常30秒或更短）
- 视频处理需要几分钟甚至更长时间
- 请求在完成前就被超时中断

**症状**：
- 上传成功
- 点击"开始处理"后很快显示失败
- 浏览器Network标签显示请求超时或中断

**解决方案**：
- 需要改为异步处理（推荐）
- 或升级到Render付费计划（支持更长的超时时间）

### 2. 后端服务资源不足

**问题**：
- Render免费层资源有限（CPU、内存）
- 视频处理需要大量资源
- 可能导致处理失败或超时

**症状**：
- 处理开始后一段时间失败
- Render日志显示内存不足或CPU限制

**解决方案**：
- 使用较小的测试视频
- 或升级到付费计划

### 3. 依赖缺失

**问题**：
- Render环境中缺少必要的依赖（ffmpeg、Python库等）

**症状**：
- Render日志显示导入错误或命令未找到

**解决方案**：
- 检查Render日志
- 确认所有依赖都已安装

### 4. 并行处理器调用失败

**问题**：
- 并行处理器内部错误
- 文件路径问题
- 子进程调用失败

**症状**：
- Render日志显示详细的错误信息

**解决方案**：
- 查看Render日志获取详细错误
- 检查文件路径和权限

## 诊断步骤

### 步骤1：检查浏览器控制台

1. **打开浏览器开发者工具**（F12）

2. **查看Console标签**
   - 查看是否有JavaScript错误
   - 查看是否有网络错误

3. **查看Network标签**
   - 找到 `/api/process` 请求
   - 查看请求状态码：
     - `200` = 请求成功，但处理失败
     - `500` = 服务器错误
     - `504` = 网关超时
     - `timeout` = 请求超时
   - 查看响应内容，可能包含错误详情

### 步骤2：检查Render日志

1. **访问Render Dashboard**
   - https://dashboard.render.com
   - 进入你的后端服务

2. **查看日志**
   - 点击 "Logs" 标签
   - 查看最新的日志信息
   - 查找错误信息（ERROR、Exception等）

3. **常见错误信息**：
   - `ImportError` = 依赖缺失
   - `FileNotFoundError` = 文件路径问题
   - `Timeout` = 处理超时
   - `MemoryError` = 内存不足

### 步骤3：测试后端健康检查

1. **访问健康检查接口**
   ```
   https://beatsync-backend-asha.onrender.com/api/health
   ```
   - 确认服务正常运行

2. **检查服务状态**
   - 在Render Dashboard中，确认服务状态为 "Live"

## 快速修复

### 修复1：增强错误显示（已实现）

前端现在会显示更详细的错误信息，包括：
- HTTP状态码
- 后端返回的错误消息
- 网络错误详情

### 修复2：检查Render日志

1. **访问Render Dashboard**
2. **查看日志**，找到具体的错误信息
3. **根据错误信息**采取相应的修复措施

### 修复3：使用较小的测试视频

如果资源不足：
1. 使用较小的测试视频（几MB）
2. 确认处理流程正常
3. 再尝试较大的视频

## 长期解决方案

### 方案1：改为异步处理（推荐）

**优点**：
- 不受HTTP超时限制
- 更好的用户体验
- 可以处理长时间任务

**实现方式**：
- 使用Celery + Redis（需要付费服务）
- 或使用Render的Background Workers
- 前端轮询或WebSocket获取处理状态

### 方案2：升级Render计划

**优点**：
- 支持更长的超时时间
- 更多资源（CPU、内存）
- 更好的性能

**缺点**：
- 需要付费（$7/月起）

### 方案3：优化处理流程

**优化方向**：
- 减少处理时间
- 优化资源使用
- 添加进度反馈

## 临时解决方案

如果急需使用，可以：

1. **使用本地处理**
   - 在本地运行后端服务
   - 前端连接到本地后端
   - 不受超时限制

2. **分批处理**
   - 将大视频分成小段
   - 分别处理后再合并

## 需要帮助？

如果问题仍然存在，请提供：

1. **浏览器控制台错误信息**（F12 → Console）
2. **Network标签的请求详情**（F12 → Network → /api/process）
3. **Render日志**（Dashboard → Logs）
4. **测试视频大小**（文件大小、时长）

## 常见错误信息

### "处理失败: 处理失败"
- **原因**：后端返回了失败状态，但没有详细错误信息
- **解决**：查看Render日志获取详细错误

### "处理失败: HTTP 504: Gateway Timeout"
- **原因**：请求超时
- **解决**：需要改为异步处理或升级计划

### "处理失败: HTTP 500: Internal Server Error"
- **原因**：服务器内部错误
- **解决**：查看Render日志获取详细错误

### "处理失败: Failed to fetch"
- **原因**：网络连接问题或CORS错误
- **解决**：检查网络连接和CORS配置

