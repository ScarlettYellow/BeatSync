<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订阅系统 UI 测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            padding: 20px;
            background: #F5F5F5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .test-section {
            margin-bottom: 32px;
        }
        .test-section h2 {
            font-size: 20px;
            margin-bottom: 16px;
            color: #333;
        }
        .test-button {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 12px;
            margin-bottom: 12px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-result {
            margin-top: 16px;
            padding: 16px;
            background: #F0F0F0;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .subscription-section {
            margin-top: 32px;
            margin-bottom: 24px;
        }
        .subscription-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .subscription-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 16px;
        }
        .subscription-status {
            margin-bottom: 16px;
        }
        .subscription-status-text {
            font-size: 16px;
            color: #666666;
            line-height: 1.5;
        }
        .subscription-status-text.active {
            color: #4CAF50;
        }
        .subscription-status-text.inactive {
            color: #666666;
        }
        .subscription-status-text.warning {
            color: #FF9800;
        }
        .subscription-status-text.error {
            color: #f44336;
        }
        .subscription-status-text.loading {
            color: #2196F3;
        }
        .subscription-status-text.success {
            color: #4CAF50;
        }
        .subscription-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .subscription-btn {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .subscription-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .subscription-btn:disabled {
            background-color: #CCCCCC;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .subscription-btn.secondary {
            background-color: #6c757d;
        }
        .subscription-btn.secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        .products-section {
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .products-section h4 {
            font-size: 18px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 16px;
        }
        .products-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .product-card {
            border: 1px solid #E0E0E0;
            border-radius: 8px;
            padding: 16px;
            background: #FAFAFA;
        }
        .product-card h5 {
            font-size: 16px;
            font-weight: 600;
            color: #333333;
            margin-bottom: 8px;
        }
        .product-price {
            font-size: 20px;
            font-weight: 700;
            color: #007AFF;
            margin-bottom: 8px;
        }
        .product-description {
            font-size: 14px;
            color: #666666;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .product-buy-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        .product-buy-btn:hover:not(:disabled) {
            background-color: #45a049;
        }
        .product-buy-btn:disabled {
            background-color: #CCCCCC;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>订阅系统 UI 测试</h1>
        
        <div class="test-section">
            <h2>1. 测试订阅服务加载</h2>
            <button class="test-button" onclick="testSubscriptionService()">检查订阅服务</button>
            <div id="service-result" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>2. 测试订阅状态显示</h2>
            <button class="test-button" onclick="testSubscriptionStatus()">加载订阅状态</button>
            <div id="status-result" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>3. 测试产品列表</h2>
            <button class="test-button" onclick="testProductsList()">加载产品列表</button>
            <div id="products-result" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h2>4. 实际 UI 显示</h2>
            <p>下面的区域是实际的订阅管理界面：</p>
            
            <!-- 订阅管理区域 -->
            <div class="subscription-section" id="subscription-section" style="display: none;">
                <div class="subscription-card">
                    <h3>订阅管理</h3>
                    <div class="subscription-status" id="subscription-status">
                        <p class="subscription-status-text">加载中...</p>
                    </div>
                    <div class="subscription-actions">
                        <button class="subscription-btn" id="view-products-btn">查看订阅套餐</button>
                        <button class="subscription-btn secondary" id="restore-purchases-btn">恢复购买</button>
                    </div>
                </div>
                
                <!-- 产品列表（折叠） -->
                <div class="products-section" id="products-section" style="display: none;">
                    <h4>订阅套餐</h4>
                    <div class="products-list" id="products-list">
                        <!-- 产品列表将通过 JavaScript 动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 注意：不在这里引入 subscription.js，使用纯模拟服务 -->
    <!-- <script src="subscription.js?v=20251275"></script> -->
    
    <script>
        // 在加载真实 subscription.js 之前，先定义模拟服务
        // 强制使用模拟订阅服务（用于测试，覆盖真实的 subscriptionService）
        window.subscriptionService = {
            checkAvailability: async () => {
                return {
                    available: true,
                    message: '订阅功能可用（模拟测试环境）'
                };
            },
            getSubscriptionStatus: async () => {
                // 模拟未订阅状态，显示"免费试用1周"
                return {
                    hasActiveSubscription: false,
                    message: '未登录',
                    credits: {
                        remaining: 0,
                        total: 0
                    }
                };
            },
            getAvailableProducts: async () => {
                return [
                    {
                        productId: 'basic_monthly',
                        displayName: '基础版 - 连续包月',
                        displayPrice: '¥15',
                        description: '50次下载/月'
                    },
                    {
                        productId: 'basic_yearly',
                        displayName: '基础版 - 连续包年',
                        displayPrice: '¥99',
                        description: '600次下载/年（平均50次/月）'
                    },
                    {
                        productId: 'premium_monthly',
                        displayName: '高级版 - 连续包月',
                        displayPrice: '¥69',
                        description: '1000次下载/月'
                    },
                    {
                        productId: 'premium_yearly',
                        displayName: '高级版 - 连续包年',
                        displayPrice: '¥499',
                        description: '12000次下载/年（平均1000次/月）'
                    },
                    {
                        productId: 'pack_10',
                        displayName: '下载次数包 - 10次',
                        displayPrice: '¥5',
                        description: '一次性购买，10次下载'
                    },
                    {
                        productId: 'pack_20',
                        displayName: '下载次数包 - 20次',
                        displayPrice: '¥9',
                        description: '一次性购买，20次下载'
                    },
                    {
                        productId: 'pack_50',
                        displayName: '下载次数包 - 50次',
                        displayPrice: '¥20',
                        description: '一次性购买，50次下载'
                    }
                ];
            },
            purchase: async (productId) => {
                return {
                    success: false,
                    message: '这是测试环境，无法实际购买'
                };
            },
            restorePurchases: async () => {
                return {
                    success: false,
                    message: '这是测试环境，无法恢复购买'
                };
            },
            getUserToken: async () => {
                return null; // 模拟未登录
            },
            saveUserToken: async (token) => {
                console.log('模拟保存Token:', token);
            }
        };
        
        console.log('✓ 已加载模拟订阅服务（测试环境）');
        
        // 即使 subscription.js 加载后，也要确保使用模拟服务
        // 监听 script 加载完成，然后再次覆盖
        window.addEventListener('load', () => {
            // 延迟执行，确保 subscription.js 已加载
            setTimeout(() => {
                if (window.subscriptionService) {
                    // 保存原始方法（如果需要）
                    const originalCheckAvailability = window.subscriptionService.checkAvailability;
                    const originalGetAvailableProducts = window.subscriptionService.getAvailableProducts;
                    
                    // 强制覆盖方法
                    window.subscriptionService.checkAvailability = async () => {
                        return {
                            available: true,
                            message: '订阅功能可用（模拟测试环境）'
                        };
                    };
                    
                    window.subscriptionService.getAvailableProducts = async () => {
                        return [
                            {
                                productId: 'basic_monthly',
                                displayName: '基础版 - 连续包月',
                                displayPrice: '¥15',
                                description: '50次下载/月'
                            },
                            {
                                productId: 'basic_yearly',
                                displayName: '基础版 - 连续包年',
                                displayPrice: '¥99',
                                description: '600次下载/年（平均50次/月）'
                            },
                            {
                                productId: 'premium_monthly',
                                displayName: '高级版 - 连续包月',
                                displayPrice: '¥69',
                                description: '1000次下载/月'
                            },
                            {
                                productId: 'premium_yearly',
                                displayName: '高级版 - 连续包年',
                                displayPrice: '¥499',
                                description: '12000次下载/年（平均1000次/月）'
                            },
                            {
                                productId: 'pack_10',
                                displayName: '下载次数包 - 10次',
                                displayPrice: '¥5',
                                description: '一次性购买，10次下载'
                            },
                            {
                                productId: 'pack_20',
                                displayName: '下载次数包 - 20次',
                                displayPrice: '¥9',
                                description: '一次性购买，20次下载'
                            },
                            {
                                productId: 'pack_50',
                                displayName: '下载次数包 - 50次',
                                displayPrice: '¥20',
                                description: '一次性购买，50次下载'
                            }
                        ];
                    };
                    
                    window.subscriptionService.getSubscriptionStatus = async () => {
                        return {
                            hasActiveSubscription: false,
                            message: '未登录',
                            credits: {
                                remaining: 0,
                                total: 0
                            }
                        };
                    };
                    
                    console.log('✓ 已强制覆盖订阅服务方法（测试环境）');
                }
            }, 100);
        });
        
        // 测试函数
        function testSubscriptionService() {
            const resultDiv = document.getElementById('service-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '检查中...';
            
            subscriptionService.checkAvailability().then(result => {
                resultDiv.textContent = JSON.stringify(result, null, 2);
            }).catch(error => {
                resultDiv.textContent = '错误: ' + error.message;
            });
        }
        
        function testSubscriptionStatus() {
            const resultDiv = document.getElementById('status-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '加载中...';
            
            subscriptionService.getSubscriptionStatus().then(result => {
                resultDiv.textContent = JSON.stringify(result, null, 2);
            }).catch(error => {
                resultDiv.textContent = '错误: ' + error.message;
            });
        }
        
        function testProductsList() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = '加载中...';
            
            subscriptionService.getAvailableProducts().then(products => {
                resultDiv.textContent = JSON.stringify(products, null, 2);
            }).catch(error => {
                resultDiv.textContent = '错误: ' + error.message;
            });
        }
        
        // 初始化订阅 UI（使用实际代码）
        const subscriptionSection = document.getElementById('subscription-section');
        const subscriptionStatus = document.getElementById('subscription-status');
        const viewProductsBtn = document.getElementById('view-products-btn');
        const restorePurchasesBtn = document.getElementById('restore-purchases-btn');
        const productsSection = document.getElementById('products-section');
        const productsList = document.getElementById('products-list');
        
        async function initSubscription() {
            try {
                // 在测试环境中，直接显示订阅区域（不检查可用性）
                subscriptionSection.style.display = 'block';
                
                // 加载订阅状态
                await loadSubscriptionStatus();
                
                // 绑定事件
                if (viewProductsBtn) {
                    viewProductsBtn.addEventListener('click', toggleProductsList);
                }
                if (restorePurchasesBtn) {
                    restorePurchasesBtn.addEventListener('click', handleRestorePurchases);
                }
                
                console.log('✓ 订阅UI初始化完成');
            } catch (error) {
                console.error('初始化订阅功能失败:', error);
                // 即使出错也显示订阅区域
                subscriptionSection.style.display = 'block';
                updateSubscriptionStatus('初始化失败，请刷新页面', 'error');
            }
        }
        
        async function loadSubscriptionStatus() {
            try {
                updateSubscriptionStatus('加载中...', 'loading');
                
                const status = await subscriptionService.getSubscriptionStatus();
                
                if (status && status.hasActiveSubscription) {
                    const credits = status.credits || {};
                    const remaining = credits.remaining || 0;
                    const total = credits.total || 0;
                    updateSubscriptionStatus(
                        `已订阅 | 剩余下载次数: ${remaining}/${total}`,
                        'active'
                    );
                } else {
                    // 未订阅状态，显示"免费试用1周"
                    updateSubscriptionStatus('未订阅 | 免费试用1周', 'inactive');
                }
            } catch (error) {
                console.error('加载订阅状态失败:', error);
                updateSubscriptionStatus('加载失败，请重试', 'error');
            }
        }
        
        function updateSubscriptionStatus(message, type = 'info') {
            if (!subscriptionStatus) return;
            
            const statusText = subscriptionStatus.querySelector('.subscription-status-text');
            if (statusText) {
                statusText.textContent = message;
                statusText.className = `subscription-status-text ${type}`;
            }
        }
        
        async function toggleProductsList() {
            if (!productsSection) return;
            
            const isVisible = productsSection.style.display !== 'none';
            
            if (isVisible) {
                productsSection.style.display = 'none';
                if (viewProductsBtn) {
                    viewProductsBtn.textContent = '查看订阅套餐';
                }
            } else {
                productsSection.style.display = 'block';
                if (viewProductsBtn) {
                    viewProductsBtn.textContent = '收起订阅套餐';
                }
                
                await loadProductsList();
            }
        }
        
        async function loadProductsList() {
            try {
                if (!productsList) return;
                
                productsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">加载中...</p>';
                
                const products = await subscriptionService.getAvailableProducts();
                
                if (!products || products.length === 0) {
                    productsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无可用套餐</p>';
                    return;
                }
                
                productsList.innerHTML = '';
                
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsList.appendChild(productCard);
                });
            } catch (error) {
                console.error('加载产品列表失败:', error);
                if (productsList) {
                    productsList.innerHTML = `<p style="text-align: center; color: #f44336; padding: 20px;">加载失败: ${error.message}</p>`;
                }
            }
        }
        
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const title = document.createElement('h5');
            title.textContent = product.displayName || product.productId;
            card.appendChild(title);
            
            const price = document.createElement('p');
            price.className = 'product-price';
            price.textContent = product.displayPrice || '价格待定';
            card.appendChild(price);
            
            const description = document.createElement('p');
            description.className = 'product-description';
            description.textContent = product.description || '';
            card.appendChild(description);
            
            const buyBtn = document.createElement('button');
            buyBtn.className = 'product-buy-btn';
            buyBtn.textContent = '购买';
            buyBtn.addEventListener('click', () => {
                alert(`测试环境：点击了购买 ${product.productId}`);
            });
            card.appendChild(buyBtn);
            
            return card;
        }
        
        async function handleRestorePurchases() {
            try {
                updateSubscriptionStatus('恢复中...', 'loading');
                
                const result = await subscriptionService.restorePurchases();
                
                if (result.success) {
                    updateSubscriptionStatus('恢复成功！', 'success');
                    setTimeout(() => {
                        loadSubscriptionStatus();
                    }, 1000);
                } else {
                    // 恢复失败后，显示提示信息，然后恢复到初始状态
                    updateSubscriptionStatus(`恢复失败: ${result.message || '未找到购买记录'}`, 'error');
                    // 3秒后恢复到初始状态
                    setTimeout(() => {
                        loadSubscriptionStatus();
                    }, 3000);
                }
            } catch (error) {
                console.error('恢复购买失败:', error);
                updateSubscriptionStatus(`恢复失败: ${error.message}`, 'error');
                // 3秒后恢复到初始状态
                setTimeout(() => {
                    loadSubscriptionStatus();
                }, 3000);
            }
        }
        
        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            initSubscription();
        });
    </script>
</body>
</html>

